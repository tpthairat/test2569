<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ระบบสอบออนไลน์</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
// ===================== Firebase Setup =====================
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, collection, addDoc, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// ใส่ค่า config Firebase ของคุณตรงนี้
const firebaseConfig = {
   apiKey: "AIzaSyB8j96zKNrU_ZqkXm6uvamdF-vpjqzK-aA",
  authDomain: "test2569-319f6.firebaseapp.com",
  databaseURL: "https://test2569-319f6-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "test2569-319f6",
  storageBucket: "test2569-319f6.firebasestorage.app",
  messagingSenderId: "3578824826",
  appId: "1:3578824826:web:38e5956c347c869f0153c3",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();

// ===================== ตัวแปร Global =====================
let currentUser = null;
let examQuestions = [];
let currentAnswers = {};
let timerDuration = 30 * 60; // 30 นาที
let timerInterval = null;

// ===================== Role Check + Routing =====================
function checkRole(user) {
    const userRef = doc(db, "users", user.uid);
    getDoc(userRef).then(docSnap => {
        if(docSnap.exists()) {
            const role = docSnap.data().role;
            if(role === "admin") {
                loadAdminDashboard();
            } else if(role === "student") {
                loadExamStartPage();
            } else {
                alert("คุณไม่มีสิทธิ์ใช้งานระบบ");
                signOut(auth);
            }
        } else {
            alert("ผู้ใช้ไม่มีข้อมูล role");
            signOut(auth);
        }
    });
}

onAuthStateChanged(auth, user => {
    if(user) {
        currentUser = user;
        checkRole(user);
    } else {
        loadLoginPage();
    }
});

// ===================== หน้า Login =====================
function loadLoginPage() {
    document.body.innerHTML = `
    <div class="flex justify-center items-center h-screen bg-gray-100">
      <div class="bg-white p-8 rounded shadow w-full max-w-md">
        <h2 class="text-2xl font-bold mb-6 text-center">เข้าสู่ระบบสอบ</h2>
        <input id="email" type="email" placeholder="อีเมล" class="w-full mb-4 p-2 border rounded">
        <input id="password" type="password" placeholder="รหัสผ่าน" class="w-full mb-4 p-2 border rounded">
        <button id="loginBtn" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">เข้าสู่ระบบ</button>
      </div>
    </div>
    `;
    document.getElementById("loginBtn").addEventListener("click", async () => {
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            currentUser = userCredential.user;
            checkRole(currentUser);
        } catch(err) {
            alert(err.message);
        }
    });
}

// ===================== หน้าเริ่มสอบ =====================
function loadExamStartPage() {
    document.body.innerHTML = `
    <div class="p-4 max-w-md mx-auto mt-10 bg-white rounded shadow">
      <h2 class="text-xl font-bold mb-4">สวัสดี ${currentUser.email}</h2>
      <p class="mb-4">คุณพร้อมจะทำข้อสอบหรือไม่?</p>
      <button id="startExamBtn" class="w-full bg-green-500 p-2 text-white rounded hover:bg-green-600">เริ่มข้อสอบ</button>
      <button id="logoutBtn" class="w-full mt-2 bg-red-500 p-2 text-white rounded hover:bg-red-600">ออกจากระบบ</button>
    </div>
    `;
    document.getElementById("startExamBtn").addEventListener("click", loadExamPage);
    document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth));
}

// ===================== ดึงข้อสอบจาก Firestore =====================
async function loadExamQuestions() {
    examQuestions = [];
    const qSnap = await getDocs(collection(db, "questionBank"));
    qSnap.forEach(doc => {
        examQuestions.push({ id: doc.id, ...doc.data() });
    });
    examQuestions = examQuestions.sort(() => Math.random() - 0.5); // สุ่มข้อสอบ
}

// ===================== หน้า Exam =====================
async function loadExamPage() {
    await loadExamQuestions();
    currentAnswers = {};
    startTimer();

    let html = `
    <div class="p-4 max-w-xl mx-auto">
      <div id="timer" class="text-red-600 text-xl font-bold mb-4 text-right"></div>
      <form id="examForm" class="space-y-4">
    `;

    examQuestions.forEach((q, index) => {
        let options = q.options.sort(() => Math.random() - 0.5);
        html += `
        <div class="p-4 border rounded shadow">
          <p class="font-semibold mb-2">ข้อที่ ${index+1}: ${q.questionText}</p>
          ${options.map(opt => `
            <label class="block mb-1">
              <input type="radio" name="q${index}" value="${opt}" class="mr-2">
              ${opt}
            </label>
          `).join('')}
        </div>
        `;
    });

    html += `
      <button type="button" id="submitExamBtn" class="w-full bg-blue-500 p-2 text-white rounded hover:bg-blue-600">ส่งข้อสอบ</button>
    </form>
    </div>
    `;

    document.body.innerHTML = html;
    document.getElementById("submitExamBtn").addEventListener("click", submitExam);
}

// ===================== ระบบจับเวลา =====================
function startTimer() {
    let duration = timerDuration;
    const timerEl = document.getElementById("timer");
    timerInterval = setInterval(() => {
        let minutes = Math.floor(duration/60);
        let seconds = duration % 60;
        timerEl.textContent = `${minutes}:${seconds < 10 ? "0" : ""}${seconds}`;
        if(duration <= 0) {
            clearInterval(timerInterval);
            submitExam();
        }
        duration--;
    }, 1000);
}

// ===================== ส่งข้อสอบ =====================
async function submitExam() {
    clearInterval(timerInterval);
    const form = document.getElementById("examForm");
    if(form) {
        const formData = new FormData(form);
        examQuestions.forEach((q,index) => {
            currentAnswers[`q${index}`] = formData.get(`q${index}`) || "";
        });
    }

    // คำนวณคะแนน
    let score = 0;
    examQuestions.forEach((q,index) => {
        if(currentAnswers[`q${index}`] === q.answer) score++;
    });

    // บันทึก Firestore
    await addDoc(collection(db, "examResults"), {
        uid: currentUser.uid,
        name: currentUser.email,
        score: score,
        answers: currentAnswers,
        startTime: new Date(),
        endTime: new Date(),
        timeUsed: "ไม่ระบุ",
        device: navigator.userAgent,
        submittedAt: new Date()
    });

    alert(`คุณได้คะแนน ${score} คะแนน`);
    loadExamStartPage();
}

// ===================== หน้า Admin Dashboard + Manage Questions =====================
async function loadAdminDashboard() {
    document.body.innerHTML = `
    <div class="p-4 max-w-4xl mx-auto">
      <h2 class="text-2xl font-bold mb-4">Admin Dashboard</h2>
      <button id="logoutBtn" class="mb-4 bg-red-500 p-2 text-white rounded hover:bg-red-600">ออกจากระบบ</button>

      <h3 class="text-xl font-semibold mt-4 mb-2">ผู้เข้าสอบ</h3>
      <table class="w-full border mb-6">
        <thead class="bg-gray-200">
          <tr>
            <th class="border p-2">ชื่อ</th>
            <th class="border p-2">คะแนน</th>
            <th class="border p-2">เวลาใช้</th>
          </tr>
        </thead>
        <tbody id="examResultsTable"></tbody>
      </table>

      <h3 class="text-xl font-semibold mt-4 mb-2">จัดการข้อสอบ</h3>
      <div class="mb-4">
        <input id="newQuestionText" type="text" placeholder="คำถาม" class="w-full mb-2 p-2 border rounded">
        <input id="newOptionA" type="text" placeholder="ตัวเลือก A" class="w-full mb-2 p-2 border rounded">
        <input id="newOptionB" type="text" placeholder="ตัวเลือก B" class="w-full mb-2 p-2 border rounded">
        <input id="newOptionC" type="text" placeholder="ตัวเลือก C" class="w-full mb-2 p-2 border rounded">
        <input id="newOptionD" type="text" placeholder="ตัวเลือก D" class="w-full mb-2 p-2 border rounded">
        <input id="newAnswer" type="text" placeholder="เฉลย (A/B/C/D)" class="w-full mb-2 p-2 border rounded">
        <button id="addQuestionBtn" class="w-full bg-green-500 p-2 text-white rounded hover:bg-green-600">เพิ่มข้อสอบ</button>
      </div>

      <table class="w-full border">
        <thead class="bg-gray-200">
          <tr>
            <th class="border p-2">คำถาม</th>
            <th class="border p-2">เฉลย</th>
            <th class="border p-2">จัดการ</th>
          </tr>
        </thead>
        <tbody id="questionBankTable"></tbody>
      </table>
    </div>
    `;

    document.getElementById("logoutBtn").addEventListener("click", () => signOut(auth));
    document.getElementById("addQuestionBtn").addEventListener("click", addQuestion);
    loadExamResults();
    loadQuestionBank();
}

// ===================== ฟังก์ชันจัดการข้อสอบ =====================
async function addQuestion() {
    const qText = document.getElementById("newQuestionText").value;
    const options = [
        document.getElementById("newOptionA").value,
        document.getElementById("newOptionB").value,
        document.getElementById("newOptionC").value,
        document.getElementById("newOptionD").value
    ];
    const answer = document.getElementById("newAnswer").value.toUpperCase();

    if(!qText || !options.every(o=>o) || !["A","B","C","D"].includes(answer)) {
        alert("กรอกข้อมูลไม่ครบหรือเฉลยไม่ถูกต้อง");
        return;
    }

    await addDoc(collection(db, "questionBank"), {
        questionText: qText,
        options: options,
        answer: answer
    });

    alert("เพิ่มข้อสอบเรียบร้อยแล้ว");
    loadQuestionBank();
}

async function loadQuestionBank() {
    const tableBody = document.getElementById("questionBankTable");
    tableBody.innerHTML = "";
    const snap = await getDocs(collection(db, "questionBank"));
    snap.forEach(docSnap => {
        const data = docSnap.data();
        tableBody.innerHTML += `
        <tr>
            <td class="border p-2">${data.questionText}</td>
            <td class="border p-2">${data.answer}</td>
            <td class="border p-2 flex gap-2">
                <button onclick="editQuestion('${docSnap.id}')" class="bg-yellow-500 text-white p-1 rounded hover:bg-yellow-600">แก้ไข</button>
                <button onclick="deleteQuestion('${docSnap.id}')" class="bg-red-500 text-white p-1 rounded hover:bg-red-600">ลบ</button>
            </td>
        </tr>
        `;
    });
}

async function editQuestion(id) {
    const docRef = doc(db, "questionBank", id);
    const docSnap = await getDoc(docRef);
    if(docSnap.exists()) {
        const data = docSnap.data();
        const newQ = prompt("แก้ไขคำถาม:", data.questionText);
        const newOptions = [
            prompt("ตัวเลือก A:", data.options[0]),
            prompt("ตัวเลือก B:", data.options[1]),
            prompt("ตัวเลือก C:", data.options[2]),
            prompt("ตัวเลือก D:", data.options[3])
        ];
        const newAnswer = prompt("เฉลย (A/B/C/D):", data.answer).toUpperCase();

        if(!newQ || !newOptions.every(o=>o) || !["A","B","C","D"].includes(newAnswer)) {
            alert("ข้อมูลไม่ครบหรือเฉลยไม่ถูกต้อง");
            return;
        }

        await updateDoc(docRef, {
            questionText: newQ,
            options: newOptions,
            answer: newAnswer
        });
        alert("แก้ไขข้อสอบเรียบร้อยแล้ว");
        loadQuestionBank();
    }
}

async function deleteQuestion(id) {
    if(confirm("คุณแน่ใจหรือไม่ที่จะลบข้อสอบนี้?")) {
        await deleteDoc(doc(db, "questionBank", id));
        alert("ลบข้อสอบเรียบร้อยแล้ว");
        loadQuestionBank();
    }
}

// ===================== โหลดผลสอบ =====================
async function loadExamResults() {
    const tableBody = document.getElementById("examResultsTable");
    tableBody.innerHTML = "";
    const snap = await getDocs(collection(db, "examResults"));
    snap.forEach(docSnap => {
        const data = docSnap.data();
        tableBody.innerHTML += `
        <tr>
            <td class="border p-2">${data.name}</td>
            <td class="border p-2">${data.score}</td>
            <td class="border p-2">${data.timeUsed}</td>
        </tr>
        `;
    });
}
</script>
</head>
<body class="bg-gray-100">

</body>
</html>
