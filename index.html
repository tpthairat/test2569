<html lang="th">
 <head>
  <script>
window.FIREBASE_CONFIG = {
    apiKey: "AIzaSyB8j96zKNrU_ZqkXm6uvamdF-vpjqzK-aA",
    authDomain: "test2569-319f6.firebaseapp.com",
    databaseURL: "https://test2569-319f6-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "test2569-319f6",
    storageBucket: "test2569-319f6.firebasestorage.app",
    messagingSenderId: "3578824826",
    appId: "1:3578824826:web:38e5956c347c869f0153c3"
};
</script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script><!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Sarabun', 'Noto Sans Thai', sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .progress-bar {
            transition: width 0.3s ease;
        }
        
        .timer-warning {
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="min-h-full bg-gradient-to-br from-blue-50 to-indigo-100">
  <div id="app" class="min-h-full"><!-- Loading Screen -->
   <div id="loading-screen" class="fixed inset-0 bg-white flex items-center justify-center z-50">
    <div class="text-center">
     <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
     <p class="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö...</p>
    </div>
   </div><!-- Navigation -->
   <nav id="navbar" class="bg-white shadow-lg border-b-2 border-blue-600 hidden">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
     <div class="flex justify-between h-16">
      <div class="flex items-center">
       <div class="flex-shrink-0">
        <h1 id="nav-title" class="text-xl font-bold text-blue-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</h1>
       </div>
      </div>
      <div class="flex items-center space-x-4"><span id="user-info" class="text-gray-700"></span> <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors hidden"> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö </button>
      </div>
     </div>
    </div>
   </nav><!-- Login Page -->
   <div id="login-page" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 hidden">
    <div class="max-w-md w-full space-y-8">
     <div class="text-center">
      <h2 class="mt-6 text-3xl font-extrabold text-gray-900">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
      <p id="welcome-text" class="mt-2 text-sm text-gray-600">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
     </div>
     <form id="login-form" class="mt-8 space-y-6">
      <div class="space-y-4">
       <div><label for="login-email" class="block text-sm font-medium text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label> <input id="login-email" name="email" type="email" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
       </div>
       <div><label for="login-password" class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input id="login-password" name="password" type="password" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
       </div>
      </div>
      <div id="login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
      <div><button type="submit" id="login-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors"> <span id="login-btn-text">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
        <div id="login-spinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2"></div></button>
      </div>
      <div class="text-center space-y-2"><button type="button" id="show-register" class="text-blue-600 hover:text-blue-500 text-sm block w-full"> ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÉ‡∏´‡∏°‡πà </button> <button type="button" id="admin-login-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg text-sm transition-colors w-full"> üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô </button>
      </div>
     </form>
    </div>
   </div><!-- Register Page -->
   <div id="register-page" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8 hidden">
    <div class="max-w-md w-full space-y-8">
     <div class="text-center">
      <h2 class="mt-6 text-3xl font-extrabold text-gray-900">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h2>
      <p class="mt-2 text-sm text-gray-600">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</p>
     </div>
     <form id="register-form" class="mt-8 space-y-6">
      <div class="space-y-4">
       <div><label for="register-name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label> <input id="register-name" name="name" type="text" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
       </div>
       <div><label for="register-email" class="block text-sm font-medium text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label> <input id="register-email" name="email" type="email" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì">
       </div>
       <div><label for="register-password" class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input id="register-password" name="password" type="password" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)">
       </div>
       <div><label for="register-confirm-password" class="block text-sm font-medium text-gray-700">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label> <input id="register-confirm-password" name="confirmPassword" type="password" required class="mt-1 appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-lg focus:outline-none focus:ring-blue-500 focus:border-blue-500 focus:z-10 sm:text-sm" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á">
       </div>
      </div>
      <div id="register-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
      <div id="register-success" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm"></div>
      <div><button type="submit" id="register-btn" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors"> <span id="register-btn-text">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</span>
        <div id="register-spinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2"></div></button>
      </div>
      <div class="text-center"><button type="button" id="show-login" class="text-blue-600 hover:text-blue-500 text-sm"> ‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß? ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö </button>
      </div>
     </form>
    </div>
   </div><!-- Dashboard -->
   <div id="dashboard" class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 hidden">
    <div class="px-4 py-6 sm:px-0">
     <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</h1>
      <p class="mt-2 text-gray-600">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥</p>
     </div><!-- Stats Cards -->
     <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-white overflow-hidden shadow rounded-lg">
       <div class="p-5">
        <div class="flex items-center">
         <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center"><span class="text-white text-sm font-bold">üìä</span>
          </div>
         </div>
         <div class="ml-5 w-0 flex-1">
          <dl>
           <dt class="text-sm font-medium text-gray-500 truncate">
            ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÅ‡∏•‡πâ‡∏ß
           </dt>
           <dd id="completed-exams" class="text-lg font-medium text-gray-900">
            0
           </dd>
          </dl>
         </div>
        </div>
       </div>
      </div>
      <div class="bg-white overflow-hidden shadow rounded-lg">
       <div class="p-5">
        <div class="flex items-center">
         <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center"><span class="text-white text-sm font-bold">‚≠ê</span>
          </div>
         </div>
         <div class="ml-5 w-0 flex-1">
          <dl>
           <dt class="text-sm font-medium text-gray-500 truncate">
            ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
           </dt>
           <dd id="average-score" class="text-lg font-medium text-gray-900">
            0%
           </dd>
          </dl>
         </div>
        </div>
       </div>
      </div>
      <div class="bg-white overflow-hidden shadow rounded-lg">
       <div class="p-5">
        <div class="flex items-center">
         <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center"><span class="text-white text-sm font-bold">üèÜ</span>
          </div>
         </div>
         <div class="ml-5 w-0 flex-1">
          <dl>
           <dt class="text-sm font-medium text-gray-500 truncate">
            ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
           </dt>
           <dd id="highest-score" class="text-lg font-medium text-gray-900">
            0%
           </dd>
          </dl>
         </div>
        </div>
       </div>
      </div>
     </div><!-- Available Exams -->
     <div class="bg-white shadow overflow-hidden sm:rounded-md">
      <div class="px-4 py-5 sm:px-6">
       <h3 class="text-lg leading-6 font-medium text-gray-900">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏ó‡∏≥</h3>
       <p class="mt-1 max-w-2xl text-sm text-gray-500">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏≥</p>
      </div>
      <ul id="exam-list" class="divide-y divide-gray-200"><!-- Exam items will be populated here -->
      </ul>
     </div><!-- Recent Results -->
     <div class="mt-8 bg-white shadow overflow-hidden sm:rounded-md">
      <div class="px-4 py-5 sm:px-6">
       <h3 class="text-lg leading-6 font-medium text-gray-900">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
       <p class="mt-1 max-w-2xl text-sm text-gray-500">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
      </div>
      <ul id="recent-results" class="divide-y divide-gray-200"><!-- Recent results will be populated here -->
      </ul>
     </div>
    </div>
   </div><!-- Exam Page -->
   <div id="exam-page" class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8 hidden">
    <div class="px-4 py-6 sm:px-0"><!-- Exam Header -->
     <div class="bg-white shadow rounded-lg p-6 mb-6">
      <div class="flex justify-between items-center">
       <div>
        <h1 id="exam-title" class="text-2xl font-bold text-gray-900"></h1>
        <p id="exam-description" class="text-gray-600 mt-1"></p>
       </div>
       <div class="text-right">
        <div id="timer" class="text-2xl font-bold text-blue-600 mb-2">
         60:00
        </div>
        <div class="text-sm text-gray-500">
         ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠
        </div>
       </div>
      </div><!-- Progress Bar -->
      <div class="mt-4">
       <div class="flex justify-between text-sm text-gray-600 mb-1"><span>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</span> <span id="progress-text">0/10</span>
       </div>
       <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progress-bar" class="progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
       </div>
      </div>
     </div><!-- Question Card -->
     <div id="question-card" class="bg-white shadow rounded-lg p-6 mb-6">
      <div class="mb-4"><span id="question-number" class="text-sm font-medium text-blue-600">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà 1</span>
       <h2 id="question-text" class="text-lg font-medium text-gray-900 mt-2"></h2>
      </div>
      <div id="choices" class="space-y-3"><!-- Choices will be populated here -->
      </div>
     </div><!-- Navigation Buttons -->
     <div class="flex justify-between"><button id="prev-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"> ‚Üê ‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ </button> <button id="next-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors"> ‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí </button> <button id="submit-exam-btn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg transition-colors hidden"> ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö </button>
     </div>
    </div>
   </div><!-- Results Page -->
   <div id="results-page" class="max-w-4xl mx-auto py-6 sm:px-6 lg:px-8 hidden">
    <div class="px-4 py-6 sm:px-0"><!-- Results Header -->
     <div class="bg-white shadow rounded-lg p-6 mb-6 text-center">
      <h1 class="text-3xl font-bold text-gray-900 mb-4">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</h1>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
       <div class="bg-blue-50 rounded-lg p-4">
        <div class="text-2xl font-bold text-blue-600" id="final-score">
         0
        </div>
        <div class="text-sm text-gray-600">
         ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
        </div>
       </div>
       <div class="bg-green-50 rounded-lg p-4">
        <div class="text-2xl font-bold text-green-600" id="correct-answers">
         0
        </div>
        <div class="text-sm text-gray-600">
         ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å
        </div>
       </div>
       <div class="bg-red-50 rounded-lg p-4">
        <div class="text-2xl font-bold text-red-600" id="wrong-answers">
         0
        </div>
        <div class="text-sm text-gray-600">
         ‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î
        </div>
       </div>
      </div>
      <div class="mt-4"><button id="back-to-dashboard" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors"> ‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î </button>
      </div>
     </div><!-- Answer Review -->
     <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-xl font-bold text-gray-900 mb-4">‡πÄ‡∏â‡∏•‡∏¢‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</h2>
      <div id="answer-review" class="space-y-6"><!-- Answer review will be populated here -->
      </div>
     </div>
    </div>
   </div><!-- History Page -->
   <div id="history-page" class="max-w-6xl mx-auto py-6 sm:px-6 lg:px-8 hidden">
    <div class="px-4 py-6 sm:px-0"><!-- History Header -->
     <div class="mb-8">
      <div class="flex items-center justify-between">
       <div>
        <h1 class="text-3xl font-bold text-gray-900">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</h1>
        <p class="mt-2 text-gray-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
       </div><button onclick="showPage('dashboard')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors"> ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î </button>
      </div>
     </div><!-- Statistics Summary -->
     <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
      <div class="bg-white overflow-hidden shadow rounded-lg">
       <div class="p-5">
        <div class="flex items-center">
         <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center"><span class="text-white text-sm font-bold">üìä</span>
          </div>
         </div>
         <div class="ml-5 w-0 flex-1">
          <dl>
           <dt class="text-sm font-medium text-gray-500 truncate">
            ‡∏ó‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
           </dt>
           <dd id="history-total-exams" class="text-lg font-medium text-gray-900">
            0
           </dd>
          </dl>
         </div>
        </div>
       </div>
      </div>
      <div class="bg-white overflow-hidden shadow rounded-lg">
       <div class="p-5">
        <div class="flex items-center">
         <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center"><span class="text-white text-sm font-bold">‚≠ê</span>
          </div>
         </div>
         <div class="ml-5 w-0 flex-1">
          <dl>
           <dt class="text-sm font-medium text-gray-500 truncate">
            ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
           </dt>
           <dd id="history-average-score" class="text-lg font-medium text-gray-900">
            0%
           </dd>
          </dl>
         </div>
        </div>
       </div>
      </div>
      <div class="bg-white overflow-hidden shadow rounded-lg">
       <div class="p-5">
        <div class="flex items-center">
         <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-purple-500 rounded-full flex items-center justify-center"><span class="text-white text-sm font-bold">üèÜ</span>
          </div>
         </div>
         <div class="ml-5 w-0 flex-1">
          <dl>
           <dt class="text-sm font-medium text-gray-500 truncate">
            ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î
           </dt>
           <dd id="history-highest-score" class="text-lg font-medium text-gray-900">
            0%
           </dd>
          </dl>
         </div>
        </div>
       </div>
      </div>
      <div class="bg-white overflow-hidden shadow rounded-lg">
       <div class="p-5">
        <div class="flex items-center">
         <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-yellow-500 rounded-full flex items-center justify-center"><span class="text-white text-sm font-bold">üìà</span>
          </div>
         </div>
         <div class="ml-5 w-0 flex-1">
          <dl>
           <dt class="text-sm font-medium text-gray-500 truncate">
            ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏ú‡πà‡∏≤‡∏ô
           </dt>
           <dd id="history-pass-rate" class="text-lg font-medium text-gray-900">
            0%
           </dd>
          </dl>
         </div>
        </div>
       </div>
      </div>
     </div><!-- Filter and Search -->
     <div class="bg-white shadow rounded-lg p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
       <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
        <div><label for="exam-filter" class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</label> <select id="exam-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500"> <option value="">‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</option> </select>
        </div>
        <div><label for="score-filter" class="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</label> <select id="score-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500"> <option value="">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</option> <option value="80-100">80-100% (‡∏ú‡πà‡∏≤‡∏ô)</option> <option value="60-79">60-79% (‡∏û‡∏≠‡πÉ‡∏ä‡πâ)</option> <option value="0-59">0-59% (‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô)</option> </select>
        </div>
       </div>
       <div class="flex space-x-2"><button onclick="exportHistoryToCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors"> üìä ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV </button> <button onclick="clearHistoryFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition-colors"> üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á </button>
       </div>
      </div>
     </div><!-- History List -->
     <div class="bg-white shadow overflow-hidden sm:rounded-md">
      <div class="px-4 py-5 sm:px-6">
       <h3 class="text-lg leading-6 font-medium text-gray-900">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</h3>
       <p class="mt-1 max-w-2xl text-sm text-gray-500">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</p>
      </div>
      <ul id="history-list" class="divide-y divide-gray-200"><!-- History items will be populated here -->
      </ul>
     </div>
    </div>
   </div><!-- Admin Panel -->
   <div id="admin-page" class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8 hidden">
    <div class="px-4 py-6 sm:px-0">
     <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900">‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</h1>
      <p class="mt-2 text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</p>
     </div><!-- Admin Tabs -->
     <div class="border-b border-gray-200 mb-6">
      <nav class="-mb-px flex space-x-8"><button id="users-tab" class="admin-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition-colors"> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ </button> <button id="exams-tab" class="admin-tab border-blue-500 text-blue-600 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm"> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö </button> <button id="csv-tab" class="admin-tab border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition-colors"> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ CSV </button>
      </nav>
     </div><!-- Users Management -->
     <div id="users-panel" class="admin-panel hidden">
      <div class="bg-white shadow overflow-hidden sm:rounded-md">
       <div class="px-4 py-5 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</p>
       </div>
       <ul id="users-list" class="divide-y divide-gray-200"><!-- Users will be populated here -->
       </ul>
      </div>
     </div><!-- Exams Management -->
     <div id="exams-panel" class="admin-panel">
      <div class="mb-6"><button id="add-exam-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors"> + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà </button>
      </div>
      <div class="bg-white shadow overflow-hidden sm:rounded-md">
       <div class="px-4 py-5 sm:px-6">
        <h3 class="text-lg leading-6 font-medium text-gray-900">‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</h3>
        <p class="mt-1 max-w-2xl text-sm text-gray-500">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</p>
       </div>
       <ul id="admin-exams-list" class="divide-y divide-gray-200"><!-- Admin exams will be populated here -->
       </ul>
      </div>
     </div><!-- CSV Import -->
     <div id="csv-panel" class="admin-panel hidden">
      <div class="bg-white shadow rounded-lg p-6">
       <h3 class="text-lg font-medium text-gray-900 mb-4">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</h3>
       <div class="mb-4">
        <p class="text-sm text-gray-600 mb-2">‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£:</p><code class="bg-gray-100 p-2 rounded text-sm block"> question,choice1,choice2,choice3,choice4,answer,explanation </code>
       </div>
       <div class="space-y-4">
        <div><label for="csv-exam-title" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</label> <input type="text" id="csv-exam-title" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö">
        </div>
        <div><label for="csv-file" class="block text-sm font-medium text-gray-700">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</label> <input type="file" id="csv-file" accept=".csv" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
        </div><button id="import-csv-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"> ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• </button>
       </div>
       <div id="csv-preview" class="mt-6 hidden">
        <h4 class="text-md font-medium text-gray-900 mb-2">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤:</h4>
        <div class="overflow-x-auto">
         <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
           <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</th>
           </tr>
          </thead>
          <tbody id="csv-preview-body" class="bg-white divide-y divide-gray-200"><!-- CSV preview will be populated here -->
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Firebase Configuration
        let app, auth, db;
        let isFirebaseMode = true;
        
        // Initialize Firebase with improved error handling
        function initializeFirebase() {
            let retryCount = 0;
            const maxRetries = 10;
            
            function attemptInit() {
                try {
                    console.log(`üîÑ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏ó‡∏µ‡πà ${retryCount + 1}/${maxRetries} - ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase...`);
                    
                    // Check if Firebase SDK is loaded
                    if (typeof firebase === 'undefined') {
                        console.log('‚è≥ Firebase SDK ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠...');
                        retryCount++;
                        
                        if (retryCount < maxRetries) {
                            setTimeout(attemptInit, 1000);
                            return;
                        } else {
                            throw new Error('Firebase SDK ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î');
                        }
                    }

                    // Use the Firebase config from the script tag
                    const firebaseConfig = window.FIREBASE_CONFIG;
                    
                    if (!firebaseConfig || !firebaseConfig.apiKey) {
                        throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase Configuration');
                    }

                    console.log('üîß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...');
                    
                    // Initialize Firebase
                    app = firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    
                    console.log('üî• Firebase ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                    console.log('üìä Project ID:', firebaseConfig.projectId);
                    console.log('üåê Auth Domain:', firebaseConfig.authDomain);
                    isFirebaseMode = true;
                    
                    // Test Firebase connection
                    testFirebaseConnection();
                    
                } catch (error) {
                    console.error('‚ùå Firebase ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ:', error);
                    isFirebaseMode = false;
                    showFirebaseError(error);
                }
            }
            
            attemptInit();
        }
        
        // Test Firebase connection
        async function testFirebaseConnection() {
            try {
                console.log('üß™ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase...');
                
                // Test Firestore connection
                await db.collection('test').limit(1).get();
                console.log('‚úÖ Firestore ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                
                // Initialize app after successful connection test
                initApp();
                
            } catch (error) {
                console.error('‚ùå ‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö Firebase ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:', error);
                
                if (error.code === 'permission-denied') {
                    showFirebaseError(new Error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á Firestore - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Security Rules'));
                } else if (error.code === 'unavailable') {
                    showFirebaseError(new Error('Firebase ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï'));
                } else {
                    showFirebaseError(error);
                }
            }
        }
        
        // Start Firebase initialization
        console.log('üöÄ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö Firebase...');
        initializeFirebase();
        
        // Function to show Firebase error
        function showFirebaseError(error) {
            console.log('‚ö†Ô∏è Firebase ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ:', error.message);
            
            // Update loading screen with error
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.innerHTML = `
                    <div class="text-center max-w-md mx-auto">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl">üî•</span>
                        </div>
                        <h2 class="text-xl font-bold text-gray-900 mb-2">‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase</h2>
                        <p class="text-gray-600 mb-4 text-sm">
                            ${error.message || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Firebase ‡πÑ‡∏î‡πâ'}
                        </p>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 text-left">
                            <h3 class="font-bold text-blue-800 mb-2">üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</h3>
                            <ul class="text-sm text-blue-700 space-y-1">
                                <li>‚Ä¢ <strong>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</strong> - ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase</li>
                                <li>‚Ä¢ <strong>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase Configuration</strong> - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key ‡πÅ‡∏•‡∏∞ Project ID</li>
                                <li>‚Ä¢ <strong>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firestore Security Rules</strong> - ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡πÑ‡∏î‡πâ</li>
                                <li>‚Ä¢ <strong>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Authentication</strong> - ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Email/Password ‡πÉ‡∏ô Firebase Console</li>
                                <li>‚Ä¢ <strong>‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console</strong> - ‡∏Å‡∏î F12 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</li>
                            </ul>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mb-4 text-left">
                            <h3 class="font-bold text-yellow-800 mb-2">üîß ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ó‡∏µ‡πà‡∏û‡∏ö‡∏ö‡πà‡∏≠‡∏¢:</h3>
                            <ul class="text-sm text-yellow-700 space-y-1">
                                <li>‚Ä¢ <strong>Permission Denied:</strong> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firestore Rules ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                                <li>‚Ä¢ <strong>Network Error:</strong> ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï</li>
                                <li>‚Ä¢ <strong>Invalid API Key:</strong> API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</li>
                                <li>‚Ä¢ <strong>Project Not Found:</strong> Project ID ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</li>
                            </ul>
                        </div>
                        
                        <div class="space-y-2">
                            <button onclick="location.reload()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg w-full transition-colors">
                                üîÑ ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà
                            </button>
                            <button onclick="showFirebaseSetup()" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg w-full transition-colors">
                                ‚öôÔ∏è ‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase
                            </button>
                        </div>
                    </div>
                `;
            }
        }
        
        // Function to show Firebase setup instructions
        function showFirebaseSetup() {
            const setupModal = document.createElement('div');
            setupModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto';
            setupModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-screen overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-gray-900">üîß ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="space-y-6 text-sm">
                        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                            <h4 class="font-bold text-yellow-800 mb-2">üìã ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á Firebase Project</h4>
                            <ol class="text-yellow-700 space-y-1 ml-4">
                                <li>1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà <a href="https://console.firebase.google.com" target="_blank" class="text-blue-600 underline">Firebase Console</a></li>
                                <li>2. ‡∏Ñ‡∏•‡∏¥‡∏Å "Create a project" ‡∏´‡∏£‡∏∑‡∏≠ "Add project"</li>
                                <li>3. ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ ‡πÄ‡∏ä‡πà‡∏ô "exam-system"</li>
                                <li>4. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Continue" ‡πÅ‡∏•‡∏∞‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à</li>
                            </ol>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                            <h4 class="font-bold text-blue-800 mb-2">üîê ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Authentication</h4>
                            <ol class="text-blue-700 space-y-1 ml-4">
                                <li>1. ‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Ñ Firebase ‡πÑ‡∏õ‡∏ó‡∏µ‡πà "Authentication"</li>
                                <li>2. ‡∏Ñ‡∏•‡∏¥‡∏Å "Get started"</li>
                                <li>3. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏ó‡πá‡∏ö "Sign-in method"</li>
                                <li>4. ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô "Email/Password"</li>
                                <li>5. ‡∏Ñ‡∏•‡∏¥‡∏Å "Save"</li>
                            </ol>
                        </div>
                        
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                            <h4 class="font-bold text-green-800 mb-2">üíæ ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 3: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firestore Database</h4>
                            <ol class="text-green-700 space-y-1 ml-4">
                                <li>1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà "Firestore Database"</li>
                                <li>2. ‡∏Ñ‡∏•‡∏¥‡∏Å "Create database"</li>
                                <li>3. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Start in test mode"</li>
                                <li>4. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å location ‡∏ó‡∏µ‡πà‡πÉ‡∏Å‡∏•‡πâ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</li>
                                <li>5. ‡∏Ñ‡∏•‡∏¥‡∏Å "Done"</li>
                            </ol>
                        </div>
                        
                        <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                            <h4 class="font-bold text-purple-800 mb-2">‚öôÔ∏è ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 4: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Web App</h4>
                            <ol class="text-purple-700 space-y-1 ml-4">
                                <li>1. ‡πÑ‡∏õ‡∏ó‡∏µ‡πà "Project settings" (‡πÄ‡∏ü‡∏∑‡∏≠‡∏á‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)</li>
                                <li>2. ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏•‡∏á‡πÑ‡∏õ‡∏´‡∏≤ "Your apps"</li>
                                <li>3. ‡∏Ñ‡∏•‡∏¥‡∏Å "Add app" ‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "Web"</li>
                                <li>4. ‡∏ï‡∏±‡πâ‡∏á‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏≠‡∏õ ‡πÄ‡∏ä‡πà‡∏ô "exam-web"</li>
                                <li>5. ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Firebase Config</li>
                                <li>6. ‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô FIREBASE_CONFIG ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡πâ‡∏î</li>
                            </ol>
                        </div>
                        
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                            <h4 class="font-bold text-red-800 mb-2">üîí ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 5: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Security Rules</h4>
                            <p class="text-red-700 mb-2">‡πÑ‡∏õ‡∏ó‡∏µ‡πà Firestore Database > Rules ‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà:</p>
                            <pre class="bg-gray-800 text-green-400 p-3 rounded text-xs overflow-x-auto">
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if request.auth != null;
    }
  }
}</pre>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t">
                        <button onclick="this.closest('.fixed').remove()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg w-full transition-colors">
                            ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(setupModal);
        }

        // Sample exam data (will be stored in Firestore)
        const sampleExams = [
            {
                id: 'general-knowledge',
                title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ',
                description: '‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£',
                timeLimit: 60,
                questions: [
                    {
                        id: 1,
                        question: '‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡πÉ‡∏î',
                        choices: ['‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', '‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà'],
                        correctAnswer: 1,
                        explanation: '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á‡∏´‡∏•‡∏ß‡∏á‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢'
                    },
                    {
                        id: 2,
                        question: '‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏∑‡∏≠‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡πÉ‡∏î',
                        choices: ['‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡πÄ‡∏à‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏¢‡∏≤', '‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡πÇ‡∏Ç‡∏á', '‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡∏ô‡πà‡∏≤‡∏ô', '‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡∏õ‡∏¥‡∏á'],
                        correctAnswer: 1,
                        explanation: '‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡πÇ‡∏Ç‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏°‡πà‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏ß‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢'
                    },
                    {
                        id: 3,
                        question: '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏°‡∏µ‡∏Å‡∏µ‡πà‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î',
                        choices: ['75', '76', '77', '78'],
                        correctAnswer: 2,
                        explanation: '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏°‡∏µ 77 ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î'
                    },
                    {
                        id: 4,
                        question: '‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏≤‡∏ï‡∏¥‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡πÉ‡∏î',
                        choices: ['‡∏ä‡πâ‡∏≤‡∏á', '‡πÄ‡∏™‡∏∑‡∏≠', '‡∏ô‡∏Å', '‡∏õ‡∏•‡∏≤'],
                        correctAnswer: 0,
                        explanation: '‡∏ä‡πâ‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏≤‡∏ï‡∏¥‡πÑ‡∏ó‡∏¢'
                    },
                    {
                        id: 5,
                        question: '‡∏ß‡∏±‡∏ô‡∏ä‡∏≤‡∏ï‡∏¥‡πÑ‡∏ó‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÉ‡∏î',
                        choices: ['5 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°', '10 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°', '28 ‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '12 ‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°'],
                        correctAnswer: 0,
                        explanation: '‡∏ß‡∏±‡∏ô‡∏ä‡∏≤‡∏ï‡∏¥‡πÑ‡∏ó‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 5 ‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
                    },
                    {
                        id: 6,
                        question: '‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡πÉ‡∏î',
                        choices: ['‡∏î‡∏≠‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏ô‡∏ô‡∏ó‡πå', '‡∏î‡∏≠‡∏¢‡∏™‡∏∏‡πÄ‡∏ó‡∏û', '‡πÄ‡∏Ç‡∏≤‡∏Ñ‡πâ‡∏≠', '‡∏î‡∏≠‡∏¢‡∏ú‡∏≤‡∏´‡∏°‡πà‡∏ô'],
                        correctAnswer: 0,
                        explanation: '‡∏î‡∏≠‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏ô‡∏ô‡∏ó‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏π‡πÄ‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢'
                    },
                    {
                        id: 7,
                        question: '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏ß‡∏µ‡∏õ‡πÉ‡∏î',
                        choices: ['‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢', '‡∏¢‡∏∏‡πÇ‡∏£‡∏õ', '‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤', '‡πÅ‡∏≠‡∏ü‡∏£‡∏¥‡∏Å‡∏≤'],
                        correctAnswer: 0,
                        explanation: '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏ó‡∏ß‡∏µ‡∏õ‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢'
                    },
                    {
                        id: 8,
                        question: '‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡πÉ‡∏î',
                        choices: ['‡∏î‡∏≠‡∏•‡∏•‡∏≤‡∏£‡πå', '‡∏ö‡∏≤‡∏ó', '‡πÄ‡∏¢‡∏ô', '‡∏¢‡∏π‡πÇ‡∏£'],
                        correctAnswer: 1,
                        explanation: '‡∏ö‡∏≤‡∏ó‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏Å‡∏∏‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢'
                    },
                    {
                        id: 9,
                        question: '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏°‡∏µ‡∏û‡∏£‡∏°‡πÅ‡∏î‡∏ô‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÉ‡∏î‡∏ö‡πâ‡∏≤‡∏á',
                        choices: ['‡πÄ‡∏°‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡∏£‡πå ‡∏•‡∏≤‡∏ß ‡∏Å‡∏±‡∏°‡∏û‡∏π‡∏ä‡∏≤ ‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢', '‡πÄ‡∏ß‡∏µ‡∏¢‡∏î‡∏ô‡∏≤‡∏° ‡∏à‡∏µ‡∏ô ‡∏≠‡∏¥‡∏ô‡πÄ‡∏î‡∏µ‡∏¢', '‡∏ü‡∏¥‡∏•‡∏¥‡∏õ‡∏õ‡∏¥‡∏ô‡∏™‡πå ‡∏≠‡∏¥‡∏ô‡πÇ‡∏î‡∏ô‡∏µ‡πÄ‡∏ã‡∏µ‡∏¢', '‡∏™‡∏¥‡∏á‡∏Ñ‡πÇ‡∏õ‡∏£‡πå ‡∏ö‡∏£‡∏π‡πÑ‡∏ô'],
                        correctAnswer: 0,
                        explanation: '‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢‡∏°‡∏µ‡∏û‡∏£‡∏°‡πÅ‡∏î‡∏ô‡∏ï‡∏¥‡∏î‡∏Å‡∏±‡∏ö ‡πÄ‡∏°‡∏µ‡∏¢‡∏ô‡∏°‡∏≤‡∏£‡πå ‡∏•‡∏≤‡∏ß ‡∏Å‡∏±‡∏°‡∏û‡∏π‡∏ä‡∏≤ ‡πÅ‡∏•‡∏∞‡∏°‡∏≤‡πÄ‡∏•‡πÄ‡∏ã‡∏µ‡∏¢'
                    },
                    {
                        id: 10,
                        question: '‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏≤‡∏ï‡∏¥‡πÑ‡∏ó‡∏¢‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡πÉ‡∏î',
                        choices: ['‡∏î‡∏≠‡∏Å‡∏ö‡∏±‡∏ß', '‡∏î‡∏≠‡∏Å‡∏£‡∏≤‡∏ä‡∏û‡∏§‡∏Å‡∏©‡πå', '‡∏î‡∏≠‡∏Å‡∏°‡∏∞‡∏•‡∏¥', '‡∏î‡∏≠‡∏Å‡∏Å‡∏∏‡∏´‡∏•‡∏≤‡∏ö'],
                        correctAnswer: 1,
                        explanation: '‡∏î‡∏≠‡∏Å‡∏£‡∏≤‡∏ä‡∏û‡∏§‡∏Å‡∏©‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏î‡∏≠‡∏Å‡πÑ‡∏°‡πâ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ä‡∏≤‡∏ï‡∏¥‡πÑ‡∏ó‡∏¢'
                    }
                ]
            },
            {
                id: 'mathematics',
                title: '‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå',
                description: '‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô',
                timeLimit: 45,
                questions: [
                    {
                        id: 1,
                        question: '15 + 28 = ?',
                        choices: ['41', '42', '43', '44'],
                        correctAnswer: 2,
                        explanation: '15 + 28 = 43'
                    },
                    {
                        id: 2,
                        question: '144 √∑ 12 = ?',
                        choices: ['10', '11', '12', '13'],
                        correctAnswer: 2,
                        explanation: '144 √∑ 12 = 12'
                    },
                    {
                        id: 3,
                        question: '7 √ó 8 = ?',
                        choices: ['54', '55', '56', '57'],
                        correctAnswer: 2,
                        explanation: '7 √ó 8 = 56'
                    },
                    {
                        id: 4,
                        question: '‚àö64 = ?',
                        choices: ['6', '7', '8', '9'],
                        correctAnswer: 2,
                        explanation: '‚àö64 = 8'
                    },
                    {
                        id: 5,
                        question: '2¬≥ = ?',
                        choices: ['6', '7', '8', '9'],
                        correctAnswer: 2,
                        explanation: '2¬≥ = 2√ó2√ó2 = 8'
                    }
                ]
            }
        ];

        // Application state
        let currentUser = null;
        let currentExam = null;
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let examTimer = null;
        let timeRemaining = 0;
        let examResults = [];

        // Default configuration
        const defaultConfig = {
            app_title: '‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå',
            exam_time: '60',
            welcome_message: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö'
        };

        // Data handler for SDK
        const dataHandler = {
            onDataChanged(data) {
                examResults = data;
                updateDashboardStats();
                updateRecentResults();
            }
        };

        // Initialize application
        async function initApp() {
            try {
                // Initialize Data SDK
                const initResult = await window.dataSdk.init(dataHandler);
                if (!initResult.isOk) {
                    console.error('Failed to initialize data SDK');
                }

                // Initialize Element SDK
                if (window.elementSdk) {
                    window.elementSdk.init({
                        defaultConfig,
                        onConfigChange: async (config) => {
                            const appTitle = config.app_title || defaultConfig.app_title;
                            const welcomeMessage = config.welcome_message || defaultConfig.welcome_message;
                            
                            document.getElementById('nav-title').textContent = appTitle;
                            document.getElementById('welcome-text').textContent = welcomeMessage;
                            document.title = appTitle;
                        },
                        mapToCapabilities: (config) => ({
                            recolorables: [],
                            borderables: [],
                            fontEditable: undefined,
                            fontSizeable: undefined
                        }),
                        mapToEditPanelValues: (config) => new Map([
                            ['app_title', config.app_title || defaultConfig.app_title],
                            ['exam_time', config.exam_time || defaultConfig.exam_time],
                            ['welcome_message', config.welcome_message || defaultConfig.welcome_message]
                        ])
                    });
                }

                // Update auth mode info
                const authModeInfo = document.getElementById('auth-mode-info');
                if (authModeInfo) {
                    authModeInfo.innerHTML = `
                        üî• ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!<br>
                        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà<br>
                        <small class="text-blue-600">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Firebase Firestore</small>
                    `;
                }

                // Setup event listeners first
                setupEventListeners();
                
                // Hide loading screen and show login page
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    showPage('login');
                }, 500);
                
            } catch (error) {
                console.error('Failed to initialize app:', error);
                document.getElementById('loading-screen').innerHTML = `
                    <div class="text-center">
                        <p class="text-red-600">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏∞‡∏ö‡∏ö</p>
                        <button onclick="location.reload()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà</button>
                    </div>
                `;
            }
        }

        function setupEventListeners() {
            // Login/Register forms
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);

            document.getElementById('show-register').addEventListener('click', () => showPage('register'));
            document.getElementById('show-login').addEventListener('click', () => showPage('login'));
            document.getElementById('admin-login-btn').addEventListener('click', handleAdminLogin);
            
            // Navigation
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('back-to-dashboard').addEventListener('click', () => showPage('dashboard'));
            
            // Exam navigation
            document.getElementById('prev-btn').addEventListener('click', previousQuestion);
            document.getElementById('next-btn').addEventListener('click', nextQuestion);
            document.getElementById('submit-exam-btn').addEventListener('click', submitExam);
            
            // Admin panel
            setupAdminEventListeners();
            
            // Add exam button
            document.getElementById('add-exam-btn').addEventListener('click', showCreateExamModal);
            
            // Firebase Auth State Observer
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    // User is signed in
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        currentUser = {
                            uid: user.uid,
                            email: user.email,
                            name: userData.name || user.displayName || user.email.split('@')[0],
                            role: userData.role || 'user',
                            status: userData.status || 'pending'
                        };
                        
                        if (userData.status === 'approved') {
                            document.getElementById('user-info').textContent = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ ${currentUser.name}`;
                            showPage(currentUser.role === 'admin' ? 'admin' : 'dashboard');
                            if (currentUser.role !== 'admin') {
                                loadExamList();
                            } else {
                                loadAdminData();
                            }
                        } else {
                            showPendingApproval();
                        }
                    }
                } else {
                    // User is signed out
                    currentUser = null;
                    showPage('login');
                }
            });
        }
        
        function setupAdminEventListeners() {
            // Admin tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    // Update active tab
                    document.querySelectorAll('.admin-tab').forEach(t => {
                        t.classList.remove('border-blue-500', 'text-blue-600');
                        t.classList.add('border-transparent', 'text-gray-500');
                    });
                    e.target.classList.add('border-blue-500', 'text-blue-600');
                    e.target.classList.remove('border-transparent', 'text-gray-500');
                    
                    // Show corresponding panel
                    document.querySelectorAll('.admin-panel').forEach(panel => {
                        panel.classList.add('hidden');
                    });
                    
                    const panelId = e.target.id.replace('-tab', '-panel');
                    document.getElementById(panelId).classList.remove('hidden');
                });
            });
            
            // CSV import
            document.getElementById('csv-file').addEventListener('change', handleCSVFileSelect);
            document.getElementById('import-csv-btn').addEventListener('click', importCSVData);
        }

        function showPage(pageName) {
            // Hide all pages
            const pages = ['login-page', 'register-page', 'dashboard', 'exam-page', 'results-page', 'admin-page', 'history-page'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
            
            // Show selected page
            const pageId = pageName === 'login' ? 'login-page' : 
                          pageName === 'register' ? 'register-page' : 
                          pageName === 'admin' ? 'admin-page' : 
                          pageName === 'history' ? 'history-page' : pageName;
            document.getElementById(pageId).classList.remove('hidden');
            
            // Show/hide navbar
            const navbar = document.getElementById('navbar');
            if (pageName === 'login' || pageName === 'register') {
                navbar.classList.add('hidden');
            } else {
                navbar.classList.remove('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
                
                // Show admin link for admin users
                const adminLink = document.getElementById('admin-link');
                if (currentUser && currentUser.role === 'admin') {
                    if (!adminLink) {
                        const adminButton = document.createElement('button');
                        adminButton.id = 'admin-link';
                        adminButton.className = 'bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors mr-2';
                        adminButton.textContent = '‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°';
                        adminButton.onclick = () => showPage('admin');
                        document.getElementById('logout-btn').parentNode.insertBefore(adminButton, document.getElementById('logout-btn'));
                    }
                } else if (adminLink) {
                    adminLink.remove();
                }
            }
            
            // Load page-specific data
            if (pageName === 'history') {
                loadFullHistory();
            }
            
            // Add fade-in animation
            document.getElementById(pageId).classList.add('fade-in');
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            // Show loading state
            setLoadingState('login', true);
            hideError('login');
            
            try {
                await auth.signInWithEmailAndPassword(email, password);
                // Auth state observer will handle the rest
            } catch (error) {
                console.error('Login error:', error);
                showError('login', getErrorMessage(error.code));
                setLoadingState('login', false);
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const confirmPassword = document.getElementById('register-confirm-password').value;
            
            // Validate passwords match
            if (password !== confirmPassword) {
                showError('register', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô');
                return;
            }
            
            if (password.length < 6) {
                showError('register', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£');
                return;
            }
            
            // Show loading state
            setLoadingState('register', true);
            hideError('register');
            
            try {
                // Create user account
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                // Save user data to Firestore
                await db.collection('users').doc(user.uid).set({
                    name: name,
                    email: email,
                    role: 'user',
                    status: 'pending',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                showSuccess('register', '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö');
                
                // Clear form
                document.getElementById('register-form').reset();
                
                // Redirect to login after 2 seconds
                setTimeout(() => {
                    showPage('login');
                }, 2000);
                
            } catch (error) {
                console.error('Registration error:', error);
                showError('register', getErrorMessage(error.code));
            } finally {
                setLoadingState('register', false);
            }
        }

        async function handleAdminLogin() {
            // Create admin login modal
            const adminModal = document.createElement('div');
            adminModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            adminModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="text-center mb-6">
                        <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl">üîê</span>
                        </div>
                        <h3 class="text-xl font-bold text-gray-900">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</h3>
                        <p class="text-sm text-gray-600 mt-2">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
                    </div>
                    
                    <form id="admin-login-form" class="space-y-4">
                        <div>
                            <label for="admin-email" class="block text-sm font-medium text-gray-700">‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô</label>
                            <input id="admin-email" name="email" type="email" required 
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                                   placeholder="admin@example.com">
                        </div>
                        <div>
                            <label for="admin-password" class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                            <input id="admin-password" name="password" type="password" required 
                                   class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm"
                                   placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô">
                        </div>
                        <div id="admin-login-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                        
                        <div class="flex space-x-3">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                            <button type="submit" id="admin-submit-btn" 
                                    class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-colors flex items-center justify-center">
                                <span id="admin-submit-text">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</span>
                                <div id="admin-submit-spinner" class="hidden animate-spin rounded-full h-4 w-4 border-b-2 border-white ml-2"></div>
                            </button>
                        </div>
                    </form>
                    

                </div>
            `;
            
            document.body.appendChild(adminModal);
            
            // Handle admin login form submission
            document.getElementById('admin-login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;
                
                // Show loading state
                const submitBtn = document.getElementById('admin-submit-btn');
                const submitText = document.getElementById('admin-submit-text');
                const submitSpinner = document.getElementById('admin-submit-spinner');
                const errorDiv = document.getElementById('admin-login-error');
                
                submitBtn.disabled = true;
                submitText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
                submitSpinner.classList.remove('hidden');
                errorDiv.classList.add('hidden');
                
                try {
                    // Sign in with Firebase Auth
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    // Check if user is admin in Firestore
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    
                    if (!userDoc.exists) {
                        // Auto-create admin for demo email
                        if (email === 'admin@test.com') {
                            await db.collection('users').doc(user.uid).set({
                                name: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö',
                                email: email,
                                role: 'admin',
                                status: 'approved',
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });
                            console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        } else {
                            await auth.signOut();
                            throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô');
                        }
                    } else {
                        const userData = userDoc.data();
                        if (userData.role !== 'admin') {
                            await auth.signOut();
                            throw new Error('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå');
                        }
                        
                        if (userData.status !== 'approved') {
                            await auth.signOut();
                            throw new Error('‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
                        }
                    }
                    
                    // Close modal - auth state observer will handle redirect
                    adminModal.remove();
                    
                } catch (error) {
                    console.error('Admin login error:', error);
                    errorDiv.textContent = error.message || getErrorMessage(error.code);
                    errorDiv.classList.remove('hidden');
                    
                    // Reset button state
                    submitBtn.disabled = false;
                    submitText.textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö';
                    submitSpinner.classList.add('hidden');
                }
            });
            
            // Focus on email input
            setTimeout(() => {
                document.getElementById('admin-email').focus();
            }, 100);
        }

        // Function to create demo admin account
        async function createDemoAdmin() {
            try {
                console.log('üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö...');
                
                // Create demo admin account
                const userCredential = await auth.createUserWithEmailAndPassword('admin@test.com', '123456');
                const user = userCredential.user;
                
                // Set admin data in Firestore
                await db.collection('users').doc(user.uid).set({
                    name: '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
                    email: 'admin@test.com',
                    role: 'admin',
                    status: 'approved',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                
                // Show success message
                const successModal = document.createElement('div');
                successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                successModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">üéâ</span>
                            </div>
                            <h3 class="text-lg font-bold mb-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4 text-left">
                                <p class="text-sm text-gray-700 mb-2"><strong>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö:</strong></p>
                                <p class="text-sm"><strong>‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong> admin@test.com</p>
                                <p class="text-sm"><strong>‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô:</strong> 123456</p>
                            </div>
                            <p class="text-gray-600 mb-4 text-sm">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    class="bg-green-600 text-white px-6 py-2 rounded-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(successModal);
                
                // Auth state observer will automatically redirect to admin panel
                
            } catch (error) {
                console.error('Error creating demo admin:', error);
                
                // If admin already exists, try to sign in
                if (error.code === 'auth/email-already-in-use') {
                    try {
                        console.log('üîÑ ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...');
                        await auth.signInWithEmailAndPassword('admin@test.com', '123456');
                        
                        const successModal = document.createElement('div');
                        successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                        successModal.innerHTML = `
                            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <span class="text-2xl">üîê</span>
                                    </div>
                                    <h3 class="text-lg font-bold mb-2">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                                    <p class="text-gray-600 mb-4">‡πÉ‡∏ä‡πâ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß</p>
                                    <button onclick="this.parentElement.parentElement.remove()" 
                                            class="bg-blue-600 text-white px-6 py-2 rounded-lg">‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(successModal);
                        
                    } catch (signInError) {
                        console.error('Error signing in to existing admin:', signInError);
                        
                        const errorModal = document.createElement('div');
                        errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                        errorModal.innerHTML = `
                            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                                <div class="text-center">
                                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <span class="text-2xl">‚ùå</span>
                                    </div>
                                    <h3 class="text-lg font-bold mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                                    <p class="text-gray-600 mb-4">${getErrorMessage(signInError.code)}</p>
                                    <button onclick="this.parentElement.parentElement.remove()" 
                                            class="bg-red-600 text-white px-6 py-2 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(errorModal);
                    }
                } else {
                    const errorModal = document.createElement('div');
                    errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    errorModal.innerHTML = `
                        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                            <div class="text-center">
                                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <span class="text-2xl">‚ùå</span>
                                </div>
                                <h3 class="text-lg font-bold mb-2">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ</h3>
                                <p class="text-gray-600 mb-4">${getErrorMessage(error.code)}</p>
                                <button onclick="this.parentElement.parentElement.remove()" 
                                        class="bg-red-600 text-white px-6 py-2 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(errorModal);
                }
            }
        }



        async function handleLogout() {
            try {
                await auth.signOut();
                currentUser = null;
                currentExam = null;
                clearInterval(examTimer);
                showPage('login');
                
                // Reset forms
                document.getElementById('login-form').reset();
            } catch (error) {
                console.error('Logout error:', error);
            }
        }
        
        // Helper functions
        function setLoadingState(formType, loading) {
            const btn = document.getElementById(`${formType}-btn`);
            const btnText = document.getElementById(`${formType}-btn-text`);
            const spinner = document.getElementById(`${formType}-spinner`);
            
            if (loading) {
                btn.disabled = true;
                btnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...';
                spinner.classList.remove('hidden');
            } else {
                btn.disabled = false;
                btnText.textContent = formType === 'login' ? '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å';
                spinner.classList.add('hidden');
            }
        }
        
        function showError(formType, message) {
            const errorDiv = document.getElementById(`${formType}-error`);
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
        }
        
        function hideError(formType) {
            const errorDiv = document.getElementById(`${formType}-error`);
            errorDiv.classList.add('hidden');
        }
        
        function showSuccess(formType, message) {
            const successDiv = document.getElementById(`${formType}-success`);
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.classList.remove('hidden');
            }
        }
        
        function getErrorMessage(errorCode) {
            switch (errorCode) {
                case 'auth/user-not-found':
                    return '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö';
                case 'auth/wrong-password':
                    return '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                case 'auth/email-already-in-use':
                    return '‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß';
                case 'auth/weak-password':
                    return '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢';
                case 'auth/invalid-email':
                    return '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
                case 'auth/too-many-requests':
                    return '‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏°‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á';
                default:
                    return '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
            }
        }
        
        function showPendingApproval() {
            document.getElementById('loading-screen').innerHTML = `
                <div class="text-center">
                    <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-2xl">‚è≥</span>
                    </div>
                    <h2 class="text-xl font-bold text-gray-900 mb-2">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</h2>
                    <p class="text-gray-600 mb-4">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</p>
                    <button onclick="handleLogout()" class="bg-blue-600 text-white px-4 py-2 rounded">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>
            `;
            document.getElementById('loading-screen').classList.remove('hidden');
        }

        async function loadExamList() {
            const examList = document.getElementById('exam-list');
            examList.innerHTML = '<li class="px-4 py-4 text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö...</li>';
            
            try {
                // Load exams from Firestore
                const examsSnapshot = await db.collection('exams').get();
                examList.innerHTML = '';
                
                if (examsSnapshot.empty) {
                    // If no exams in Firestore, create sample exams
                    await createSampleExams();
                    // Reload after creating sample exams
                    return loadExamList();
                }
                
                examsSnapshot.forEach(doc => {
                    const exam = { id: doc.id, ...doc.data() };
                    const examItem = document.createElement('li');
                    examItem.innerHTML = `
                        <div class="px-4 py-4 flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-blue-500 flex items-center justify-center">
                                        <span class="text-white font-bold">üìù</span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${exam.title}</div>
                                    <div class="text-sm text-gray-500">${exam.description}</div>
                                    <div class="text-xs text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${exam.questions?.length || 0} ‡∏Ç‡πâ‡∏≠ ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤ ${exam.timeLimit} ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="startExam('${exam.id}')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                    ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
                                </button>
                            </div>
                        </div>
                    `;
                    examList.appendChild(examItem);
                });
                
            } catch (error) {
                console.error('Error loading exams:', error);
                examList.innerHTML = '<li class="px-4 py-4 text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</li>';
            }
        }
        
        async function createSampleExams() {
            try {
                console.log('Creating sample exams in Firestore...');
                
                for (const exam of sampleExams) {
                    await db.collection('exams').doc(exam.id).set({
                        title: exam.title,
                        description: exam.description,
                        timeLimit: exam.timeLimit,
                        questions: exam.questions,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: 'system'
                    });
                }
                
                console.log('Sample exams created successfully');
            } catch (error) {
                console.error('Error creating sample exams:', error);
            }
        }

        async function startExam(examId) {
            try {
                // Load exam from Firestore
                const examDoc = await db.collection('exams').doc(examId).get();
                if (!examDoc.exists) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                    return;
                }
                
                currentExam = { id: examDoc.id, ...examDoc.data() };
                currentQuestionIndex = 0;
                userAnswers = new Array(currentExam.questions.length).fill(null);
                timeRemaining = currentExam.timeLimit * 60; // Convert to seconds
                
                // Setup exam page
                document.getElementById('exam-title').textContent = currentExam.title;
                document.getElementById('exam-description').textContent = currentExam.description;
                
                showPage('exam-page');
                startTimer();
                displayQuestion();
                
            } catch (error) {
                console.error('Error starting exam:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö');
            }
        }

        function startTimer() {
            const timerElement = document.getElementById('timer');
            
            examTimer = setInterval(() => {
                timeRemaining--;
                
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                timerElement.textContent = timeString;
                
                // Warning when less than 5 minutes
                if (timeRemaining <= 300) {
                    timerElement.classList.add('timer-warning', 'text-red-600');
                    timerElement.classList.remove('text-blue-600');
                }
                
                // Auto submit when time is up
                if (timeRemaining <= 0) {
                    clearInterval(examTimer);
                    submitExam();
                }
            }, 1000);
        }

        function displayQuestion() {
            const question = currentExam.questions[currentQuestionIndex];
            
            document.getElementById('question-number').textContent = `‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${currentQuestionIndex + 1}`;
            document.getElementById('question-text').textContent = question.question;
            
            // Update progress
            const progress = ((currentQuestionIndex + 1) / currentExam.questions.length) * 100;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = `${currentQuestionIndex + 1}/${currentExam.questions.length}`;
            
            // Display choices
            const choicesContainer = document.getElementById('choices');
            choicesContainer.innerHTML = '';
            
            question.choices.forEach((choice, index) => {
                const choiceElement = document.createElement('div');
                choiceElement.innerHTML = `
                    <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-gray-50 transition-colors ${userAnswers[currentQuestionIndex] === index ? 'border-blue-500 bg-blue-50' : 'border-gray-300'}">
                        <input type="radio" name="answer" value="${index}" class="mr-3" ${userAnswers[currentQuestionIndex] === index ? 'checked' : ''}>
                        <span class="font-medium text-gray-700 mr-2">${String.fromCharCode(65 + index)}.</span>
                        <span class="text-gray-900">${choice}</span>
                    </label>
                `;
                
                const radio = choiceElement.querySelector('input[type="radio"]');
                radio.addEventListener('change', () => {
                    userAnswers[currentQuestionIndex] = index;
                    displayQuestion(); // Refresh to show selection
                });
                
                choicesContainer.appendChild(choiceElement);
            });
            
            // Update navigation buttons
            document.getElementById('prev-btn').disabled = currentQuestionIndex === 0;
            
            if (currentQuestionIndex === currentExam.questions.length - 1) {
                document.getElementById('next-btn').classList.add('hidden');
                document.getElementById('submit-exam-btn').classList.remove('hidden');
            } else {
                document.getElementById('next-btn').classList.remove('hidden');
                document.getElementById('submit-exam-btn').classList.add('hidden');
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < currentExam.questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        async function submitExam() {
            clearInterval(examTimer);
            
            // Calculate results
            let correctCount = 0;
            currentExam.questions.forEach((question, index) => {
                if (userAnswers[index] === question.correctAnswer) {
                    correctCount++;
                }
            });
            
            const score = Math.round((correctCount / currentExam.questions.length) * 100);
            const timeTaken = (currentExam.timeLimit * 60) - timeRemaining;
            
            // Save result to Data SDK
            const resultData = {
                id: `result_${Date.now()}`,
                user_id: currentUser.email,
                exam_id: currentExam.id,
                score: score,
                total_questions: currentExam.questions.length,
                time_taken: timeTaken,
                answers: JSON.stringify(userAnswers),
                completed_at: new Date().toISOString()
            };
            
            const saveResult = await window.dataSdk.create(resultData);
            if (!saveResult.isOk) {
                console.error('Failed to save exam result');
            }
            
            // Display results
            displayResults(score, correctCount, currentExam.questions.length - correctCount);
        }

        function displayResults(score, correct, wrong) {
            document.getElementById('final-score').textContent = `${score}%`;
            document.getElementById('correct-answers').textContent = correct;
            document.getElementById('wrong-answers').textContent = wrong;
            
            // Display answer review
            const reviewContainer = document.getElementById('answer-review');
            reviewContainer.innerHTML = '';
            
            currentExam.questions.forEach((question, index) => {
                const isCorrect = userAnswers[index] === question.correctAnswer;
                const userChoice = userAnswers[index] !== null ? question.choices[userAnswers[index]] : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö';
                const correctChoice = question.choices[question.correctAnswer];
                
                const reviewItem = document.createElement('div');
                reviewItem.innerHTML = `
                    <div class="border rounded-lg p-4 ${isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                        <div class="flex items-start justify-between mb-2">
                            <h3 class="font-medium text-gray-900">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${index + 1}</h3>
                            <span class="px-2 py-1 rounded text-sm font-medium ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                ${isCorrect ? '‚úì ‡∏ñ‡∏π‡∏Å' : '‚úó ‡∏ú‡∏¥‡∏î'}
                            </span>
                        </div>
                        <p class="text-gray-700 mb-3">${question.question}</p>
                        <div class="space-y-1 text-sm">
                            <p><span class="font-medium">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</span> ${userChoice}</p>
                            <p><span class="font-medium">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å:</span> ${correctChoice}</p>
                            <p class="text-gray-600 mt-2"><span class="font-medium">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</span> ${question.explanation}</p>
                        </div>
                    </div>
                `;
                reviewContainer.appendChild(reviewItem);
            });
            
            showPage('results-page');
        }

        function updateDashboardStats() {
            if (examResults.length === 0) {
                document.getElementById('completed-exams').textContent = '0';
                document.getElementById('average-score').textContent = '0%';
                document.getElementById('highest-score').textContent = '0%';
                return;
            }
            
            const userResults = examResults.filter(result => result.user_id === currentUser?.email);
            
            document.getElementById('completed-exams').textContent = userResults.length;
            
            if (userResults.length > 0) {
                const averageScore = Math.round(userResults.reduce((sum, result) => sum + result.score, 0) / userResults.length);
                const highestScore = Math.max(...userResults.map(result => result.score));
                
                document.getElementById('average-score').textContent = `${averageScore}%`;
                document.getElementById('highest-score').textContent = `${highestScore}%`;
            }
        }

        async function updateRecentResults() {
            const recentResultsContainer = document.getElementById('recent-results');
            recentResultsContainer.innerHTML = '<li class="px-4 py-4 text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</li>';
            
            if (!currentUser) return;
            
            try {
                // Get user results from Data SDK
                const userResults = examResults
                    .filter(result => result.user_id === currentUser.email)
                    .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at))
                    .slice(0, 5);
                
                recentResultsContainer.innerHTML = '';
                
                if (userResults.length === 0) {
                    recentResultsContainer.innerHTML = `
                        <li class="px-4 py-4 text-center text-gray-500">
                            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
                        </li>
                    `;
                    return;
                }
                
                // Get exam titles from Firestore
                const examTitles = {};
                const examsSnapshot = await db.collection('exams').get();
                examsSnapshot.forEach(doc => {
                    examTitles[doc.id] = doc.data().title;
                });
                
                userResults.forEach(result => {
                    const examTitle = examTitles[result.exam_id] || '‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
                    const completedDate = new Date(result.completed_at).toLocaleDateString('th-TH');
                    const completedTime = new Date(result.completed_at).toLocaleTimeString('th-TH', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    
                    const resultItem = document.createElement('li');
                    resultItem.innerHTML = `
                        <div class="px-4 py-4 flex items-center justify-between hover:bg-gray-50 transition-colors">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-12 w-12">
                                    <div class="h-12 w-12 rounded-full ${result.score >= 80 ? 'bg-green-500' : result.score >= 60 ? 'bg-yellow-500' : 'bg-red-500'} flex items-center justify-center shadow-md">
                                        <span class="text-white font-bold text-sm">${result.score}%</span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${examTitle}</div>
                                    <div class="text-sm text-gray-500">‡∏ó‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${completedDate} ‡πÄ‡∏ß‡∏•‡∏≤ ${completedTime}</div>
                                    <div class="text-xs text-gray-400">
                                        ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ ${Math.floor(result.time_taken / 60)} ‡∏ô‡∏≤‡∏ó‡∏µ ${result.time_taken % 60} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ 
                                        ‡∏ñ‡∏π‡∏Å ${Math.round((result.score / 100) * result.total_questions)}/${result.total_questions} ‡∏Ç‡πâ‡∏≠
                                    </div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium ${result.score >= 80 ? 'text-green-600' : result.score >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${result.score >= 80 ? 'üéâ ‡∏ú‡πà‡∏≤‡∏ô' : result.score >= 60 ? '‚ö†Ô∏è ‡∏û‡∏≠‡πÉ‡∏ä‡πâ' : '‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}
                                </div>
                                <button onclick="showDetailedResult('${result.id}')" 
                                        class="mt-1 text-xs text-blue-600 hover:text-blue-800 underline">
                                    ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                                </button>
                            </div>
                        </div>
                    `;
                    recentResultsContainer.appendChild(resultItem);
                });
                
                // Add "View All History" button if user has more than 5 results
                const totalUserResults = examResults.filter(result => result.user_id === currentUser.email).length;
                if (totalUserResults > 5) {
                    const viewAllItem = document.createElement('li');
                    viewAllItem.innerHTML = `
                        <div class="px-4 py-3 text-center border-t border-gray-200">
                            <button onclick="showFullHistory()" 
                                    class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (${totalUserResults} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á) ‚Üí
                            </button>
                        </div>
                    `;
                    recentResultsContainer.appendChild(viewAllItem);
                }
                
            } catch (error) {
                console.error('Error updating recent results:', error);
                recentResultsContainer.innerHTML = '<li class="px-4 py-4 text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</li>';
            }
        }

        // Admin functions
        async function loadAdminData() {
            await loadUsersList();
            await loadAdminExamsList();
        }
        
        async function loadUsersList() {
            try {
                const usersSnapshot = await db.collection('users').get();
                const usersList = document.getElementById('users-list');
                usersList.innerHTML = '';
                
                if (usersSnapshot.empty) {
                    usersList.innerHTML = '<li class="px-4 py-4 text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</li>';
                    return;
                }
                
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    const userItem = document.createElement('li');
                    userItem.innerHTML = `
                        <div class="px-4 py-4 flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full ${userData.status === 'approved' ? 'bg-green-500' : 'bg-yellow-500'} flex items-center justify-center">
                                        <span class="text-white font-bold">${userData.name.charAt(0).toUpperCase()}</span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${userData.name}</div>
                                    <div class="text-sm text-gray-500">${userData.email}</div>
                                    <div class="text-xs text-gray-400">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå: ${userData.role === 'admin' ? '‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö' : '‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ'}</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${userData.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${userData.status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥'}
                                </span>
                                ${userData.status === 'pending' ? `
                                    <button onclick="approveUser('${doc.id}')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs transition-colors">
                                        ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥
                                    </button>
                                ` : ''}
                                <button onclick="toggleUserRole('${doc.id}', '${userData.role}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition-colors">
                                    ${userData.role === 'admin' ? '‡∏•‡∏î‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå'}
                                </button>
                                <button onclick="toggleUserStatus('${doc.id}', '${userData.status}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs transition-colors">
                                    ${userData.status === 'approved' ? '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' : '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'}
                                </button>
                            </div>
                        </div>
                    `;
                    usersList.appendChild(userItem);
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        async function approveUser(userId) {
            try {
                // Show loading state
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥...';
                
                await db.collection('users').doc(userId).update({
                    status: 'approved'
                });
                
                // Reload users list
                await loadUsersList();
                
            } catch (error) {
                console.error('Error approving user:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                
                // Reset button
                if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }
        
        async function toggleUserRole(userId, currentRole) {
            try {
                // Show loading state
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó...';
                
                const newRole = currentRole === 'admin' ? 'user' : 'admin';
                await db.collection('users').doc(userId).update({
                    role: newRole
                });
                
                // Reload users list
                await loadUsersList();
                
            } catch (error) {
                console.error('Error updating user role:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                
                // Reset button
                if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }
        
        async function toggleUserStatus(userId, currentStatus) {
            try {
                // Show loading state
                const button = event.target;
                const originalText = button.textContent;
                button.disabled = true;
                button.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó...';
                
                const newStatus = currentStatus === 'approved' ? 'disabled' : 'approved';
                await db.collection('users').doc(userId).update({
                    status: newStatus
                });
                
                // Reload users list
                await loadUsersList();
                
            } catch (error) {
                console.error('Error updating user status:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ');
                
                // Reset button
                if (button) {
                    button.disabled = false;
                    button.textContent = originalText;
                }
            }
        }
        
        async function loadAdminExamsList() {
            const examsList = document.getElementById('admin-exams-list');
            examsList.innerHTML = '<li class="px-4 py-4 text-center text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö...</li>';
            
            try {
                const examsSnapshot = await db.collection('exams').get();
                examsList.innerHTML = '';
                
                if (examsSnapshot.empty) {
                    examsList.innerHTML = '<li class="px-4 py-4 text-center text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</li>';
                    return;
                }
                
                examsSnapshot.forEach(doc => {
                    const exam = { id: doc.id, ...doc.data() };
                    const examItem = document.createElement('li');
                    examItem.innerHTML = `
                        <div class="px-4 py-4 flex items-center justify-between">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    <div class="h-10 w-10 rounded-full bg-purple-500 flex items-center justify-center">
                                        <span class="text-white font-bold">üìù</span>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">${exam.title}</div>
                                    <div class="text-sm text-gray-500">${exam.description}</div>
                                    <div class="text-xs text-gray-400">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${exam.questions?.length || 0} ‡∏Ç‡πâ‡∏≠ ‚Ä¢ ‡πÄ‡∏ß‡∏•‡∏≤ ${exam.timeLimit} ‡∏ô‡∏≤‡∏ó‡∏µ</div>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="editExam('${exam.id}')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-xs transition-colors">
                                    ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                                </button>
                                <button onclick="deleteExam('${exam.id}')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs transition-colors">
                                    ‡∏•‡∏ö
                                </button>
                            </div>
                        </div>
                    `;
                    examsList.appendChild(examItem);
                });
                
            } catch (error) {
                console.error('Error loading admin exams:', error);
                examsList.innerHTML = '<li class="px-4 py-4 text-center text-red-500">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</li>';
            }
        }
        
        async function editExam(examId) {
            try {
                // Get exam from Firestore instead of sampleExams
                const examDoc = await db.collection('exams').doc(examId).get();
                if (!examDoc.exists) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                    return;
                }
                
                const exam = { id: examDoc.id, ...examDoc.data() };
            
            const editModal = document.createElement('div');
            editModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto';
            editModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 my-8 max-h-screen overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö: ${exam.title}</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="edit-exam-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</label>
                                <input type="text" id="edit-exam-title" value="${exam.title}" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                                <input type="number" id="edit-exam-time" value="${exam.timeLimit}" min="1" max="180"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                            <textarea id="edit-exam-description" rows="2" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">${exam.description}</textarea>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-medium text-gray-900">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° (${exam.questions.length} ‡∏Ç‡πâ‡∏≠)</h4>
                                <button type="button" onclick="addNewQuestion('${examId}')" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
                                </button>
                            </div>
                            
                            <div id="questions-container" class="space-y-4">
                                ${exam.questions.map((q, index) => `
                                    <div class="border border-gray-200 rounded-lg p-4 question-item" data-question-index="${index}">
                                        <div class="flex justify-between items-start mb-3">
                                            <h5 class="font-medium text-gray-900">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${index + 1}</h5>
                                            <button type="button" onclick="removeQuestion('${examId}', ${index})" 
                                                    class="text-red-600 hover:text-red-800 text-sm">‡∏•‡∏ö</button>
                                        </div>
                                        
                                        <div class="space-y-3">
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</label>
                                                <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                                          rows="2">${q.question}</textarea>
                                            </div>
                                            
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                                ${q.choices.map((choice, choiceIndex) => `
                                                    <div>
                                                        <label class="block text-sm font-medium text-gray-700 mb-1">
                                                            ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${String.fromCharCode(65 + choiceIndex)}
                                                            ${choiceIndex === q.correctAnswer ? '<span class="text-green-600">(‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å)</span>' : ''}
                                                        </label>
                                                        <div class="flex">
                                                            <input type="text" class="choice-text flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500" 
                                                                   value="${choice}">
                                                            <button type="button" onclick="setCorrectAnswer(${index}, ${choiceIndex})" 
                                                                    class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg ${choiceIndex === q.correctAnswer ? 'bg-green-100 text-green-800' : 'bg-gray-50 text-gray-600'} hover:bg-green-100 text-sm">
                                                                ‚úì
                                                            </button>
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            
                                            <div>
                                                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                                                <textarea class="explanation-text w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                                          rows="2">${q.explanation}</textarea>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-6 border-t">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                                ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(editModal);
            
            // Handle form submission
            document.getElementById('edit-exam-form').addEventListener('submit', (e) => {
                e.preventDefault();
                saveExamChanges(examId);
                editModal.remove();
            });
            
            } catch (error) {
                console.error('Error loading exam for editing:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö');
            }
        }
        
        function addNewQuestion(examId) {
            const container = document.getElementById('questions-container');
            const questionCount = container.children.length;
            
            const newQuestionHTML = `
                <div class="border border-gray-200 rounded-lg p-4 question-item" data-question-index="${questionCount}">
                    <div class="flex justify-between items-start mb-3">
                        <h5 class="font-medium text-gray-900">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${questionCount + 1}</h5>
                        <button type="button" onclick="removeQuestion('${examId}', ${questionCount})" 
                                class="text-red-600 hover:text-red-800 text-sm">‡∏•‡∏ö</button>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</label>
                            <textarea class="question-text w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                      rows="2" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°"></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${[0,1,2,3].map(choiceIndex => `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${String.fromCharCode(65 + choiceIndex)}
                                        ${choiceIndex === 0 ? '<span class="text-green-600">(‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å)</span>' : ''}
                                    </label>
                                    <div class="flex">
                                        <input type="text" class="choice-text flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500" 
                                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${String.fromCharCode(65 + choiceIndex)}">
                                        <button type="button" onclick="setCorrectAnswer(${questionCount}, ${choiceIndex})" 
                                                class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg ${choiceIndex === 0 ? 'bg-green-100 text-green-800' : 'bg-gray-50 text-gray-600'} hover:bg-green-100 text-sm">
                                            ‚úì
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                            <textarea class="explanation-text w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                      rows="2" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢"></textarea>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newQuestionHTML);
        }
        
        function removeQuestion(examId, questionIndex) {
            const questionItem = document.querySelector(`[data-question-index="${questionIndex}"]`);
            if (questionItem) {
                questionItem.remove();
                // Update question numbers
                updateQuestionNumbers();
            }
        }
        
        function updateQuestionNumbers() {
            const questionItems = document.querySelectorAll('.question-item');
            questionItems.forEach((item, index) => {
                item.setAttribute('data-question-index', index);
                const questionNumber = item.querySelector('h5');
                if (questionNumber) {
                    questionNumber.textContent = `‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${index + 1}`;
                }
            });
        }
        
        function setCorrectAnswer(questionIndex, choiceIndex) {
            const questionItem = document.querySelector(`[data-question-index="${questionIndex}"]`);
            if (!questionItem) return;
            
            // Remove correct answer styling from all choices
            const choiceButtons = questionItem.querySelectorAll('button[onclick*="setCorrectAnswer"]');
            const choiceLabels = questionItem.querySelectorAll('label');
            
            choiceButtons.forEach((btn, idx) => {
                btn.classList.remove('bg-green-100', 'text-green-800');
                btn.classList.add('bg-gray-50', 'text-gray-600');
                
                // Update label
                const label = choiceLabels[idx + 1]; // +1 because first label is for question text
                if (label) {
                    const correctSpan = label.querySelector('.text-green-600');
                    if (correctSpan) correctSpan.remove();
                }
            });
            
            // Add correct answer styling to selected choice
            const selectedButton = choiceButtons[choiceIndex];
            const selectedLabel = choiceLabels[choiceIndex + 1];
            
            if (selectedButton) {
                selectedButton.classList.remove('bg-gray-50', 'text-gray-600');
                selectedButton.classList.add('bg-green-100', 'text-green-800');
            }
            
            if (selectedLabel) {
                selectedLabel.innerHTML += ' <span class="text-green-600">(‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å)</span>';
            }
        }
        
        async function saveExamChanges(examId) {
            try {
                // Get updated exam data
                const title = document.getElementById('edit-exam-title').value;
                const timeLimit = parseInt(document.getElementById('edit-exam-time').value);
                const description = document.getElementById('edit-exam-description').value;
                
                // Get updated questions
                const questionItems = document.querySelectorAll('.question-item');
                const questions = [];
                
                questionItems.forEach((item, index) => {
                    const questionText = item.querySelector('.question-text').value;
                    const choices = Array.from(item.querySelectorAll('.choice-text')).map(input => input.value);
                    const explanation = item.querySelector('.explanation-text').value;
                    
                    // Find correct answer
                    let correctAnswer = 0;
                    const correctButton = item.querySelector('button.bg-green-100');
                    if (correctButton) {
                        const allButtons = Array.from(item.querySelectorAll('button[onclick*="setCorrectAnswer"]'));
                        correctAnswer = allButtons.indexOf(correctButton);
                    }
                    
                    questions.push({
                        id: index + 1,
                        question: questionText,
                        choices: choices,
                        correctAnswer: correctAnswer,
                        explanation: explanation
                    });
                });
                
                // Update exam in Firestore
                await db.collection('exams').doc(examId).update({
                    title: title,
                    timeLimit: timeLimit,
                    description: description,
                    questions: questions,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser?.uid || 'unknown'
                });
                
                // Show success message first
                const successModal = document.createElement('div');
                successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                successModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">‚úÖ</span>
                            </div>
                            <h3 class="text-lg font-bold mb-2">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
                            <p class="text-gray-600 mb-4">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö "${title}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                            <button onclick="this.parentElement.parentElement.remove(); loadAdminExamsList()" 
                                    class="bg-green-600 text-white px-6 py-2 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(successModal);
                
            } catch (error) {
                console.error('Error saving exam changes:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç');
            }
        }
        
        function showCreateExamModal() {
            const createModal = document.createElement('div');
            createModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto';
            createModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 my-8 max-h-screen overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <form id="create-exam-form" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö *</label>
                                <input type="text" id="create-exam-title" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤ (‡∏ô‡∏≤‡∏ó‡∏µ) *</label>
                                <input type="number" id="create-exam-time" value="60" min="1" max="180" required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                            <textarea id="create-exam-description" rows="2" 
                                      class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                      placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö"></textarea>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="text-lg font-medium text-gray-900">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°</h4>
                                <button type="button" onclick="addNewQuestionToCreate()" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°
                                </button>
                            </div>
                            
                            <div id="create-questions-container" class="space-y-4">
                                <!-- Questions will be added here -->
                            </div>
                            
                            <div class="text-center py-8 text-gray-500" id="no-questions-message">
                                <div class="text-4xl mb-2">üìù</div>
                                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏° "+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</p>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 pt-6 border-t">
                            <button type="button" onclick="this.closest('.fixed').remove()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                                ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                            </button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                                ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(createModal);
            
            // Handle form submission
            document.getElementById('create-exam-form').addEventListener('submit', (e) => {
                e.preventDefault();
                createNewExam();
                createModal.remove();
            });
            
            // Focus on title input
            setTimeout(() => {
                document.getElementById('create-exam-title').focus();
            }, 100);
        }
        
        function addNewQuestionToCreate() {
            const container = document.getElementById('create-questions-container');
            const noQuestionsMessage = document.getElementById('no-questions-message');
            const questionCount = container.children.length;
            
            // Hide no questions message
            if (noQuestionsMessage) {
                noQuestionsMessage.style.display = 'none';
            }
            
            const newQuestionHTML = `
                <div class="border border-gray-200 rounded-lg p-4 create-question-item" data-question-index="${questionCount}">
                    <div class="flex justify-between items-start mb-3">
                        <h5 class="font-medium text-gray-900">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${questionCount + 1}</h5>
                        <button type="button" onclick="removeCreateQuestion(${questionCount})" 
                                class="text-red-600 hover:text-red-800 text-sm">‡∏•‡∏ö</button>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° *</label>
                            <textarea class="create-question-text w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                      rows="2" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°" required></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            ${[0,1,2,3].map(choiceIndex => `
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${String.fromCharCode(65 + choiceIndex)} *
                                        ${choiceIndex === 0 ? '<span class="text-green-600">(‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å)</span>' : ''}
                                    </label>
                                    <div class="flex">
                                        <input type="text" class="create-choice-text flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:ring-blue-500 focus:border-blue-500" 
                                               placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${String.fromCharCode(65 + choiceIndex)}" required>
                                        <button type="button" onclick="setCreateCorrectAnswer(${questionCount}, ${choiceIndex})" 
                                                class="px-3 py-2 border border-l-0 border-gray-300 rounded-r-lg ${choiceIndex === 0 ? 'bg-green-100 text-green-800' : 'bg-gray-50 text-gray-600'} hover:bg-green-100 text-sm">
                                            ‚úì
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</label>
                            <textarea class="create-explanation-text w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" 
                                      rows="2" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢"></textarea>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newQuestionHTML);
        }
        
        function removeCreateQuestion(questionIndex) {
            const questionItem = document.querySelector(`[data-question-index="${questionIndex}"]`);
            if (questionItem) {
                questionItem.remove();
                updateCreateQuestionNumbers();
                
                // Show no questions message if no questions left
                const container = document.getElementById('create-questions-container');
                const noQuestionsMessage = document.getElementById('no-questions-message');
                if (container.children.length === 0 && noQuestionsMessage) {
                    noQuestionsMessage.style.display = 'block';
                }
            }
        }
        
        function updateCreateQuestionNumbers() {
            const questionItems = document.querySelectorAll('.create-question-item');
            questionItems.forEach((item, index) => {
                item.setAttribute('data-question-index', index);
                const questionNumber = item.querySelector('h5');
                if (questionNumber) {
                    questionNumber.textContent = `‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${index + 1}`;
                }
                
                // Update onclick handlers for buttons
                const removeBtn = item.querySelector('button[onclick*="removeCreateQuestion"]');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeCreateQuestion(${index})`);
                }
                
                const correctBtns = item.querySelectorAll('button[onclick*="setCreateCorrectAnswer"]');
                correctBtns.forEach((btn, choiceIndex) => {
                    btn.setAttribute('onclick', `setCreateCorrectAnswer(${index}, ${choiceIndex})`);
                });
            });
        }
        
        function setCreateCorrectAnswer(questionIndex, choiceIndex) {
            const questionItem = document.querySelector(`[data-question-index="${questionIndex}"]`);
            if (!questionItem) return;
            
            // Remove correct answer styling from all choices
            const choiceButtons = questionItem.querySelectorAll('button[onclick*="setCreateCorrectAnswer"]');
            const choiceLabels = questionItem.querySelectorAll('label');
            
            choiceButtons.forEach((btn, idx) => {
                btn.classList.remove('bg-green-100', 'text-green-800');
                btn.classList.add('bg-gray-50', 'text-gray-600');
                
                // Update label
                const label = choiceLabels[idx + 1]; // +1 because first label is for question text
                if (label) {
                    const correctSpan = label.querySelector('.text-green-600');
                    if (correctSpan) correctSpan.remove();
                }
            });
            
            // Add correct answer styling to selected choice
            const selectedButton = choiceButtons[choiceIndex];
            const selectedLabel = choiceLabels[choiceIndex + 1];
            
            if (selectedButton) {
                selectedButton.classList.remove('bg-gray-50', 'text-gray-600');
                selectedButton.classList.add('bg-green-100', 'text-green-800');
            }
            
            if (selectedLabel) {
                selectedLabel.innerHTML += ' <span class="text-green-600">(‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å)</span>';
            }
        }
        
        async function createNewExam() {
            try {
                // Get form data
                const title = document.getElementById('create-exam-title').value.trim();
                const timeLimit = parseInt(document.getElementById('create-exam-time').value);
                const description = document.getElementById('create-exam-description').value.trim();
                
                // Validate required fields
                if (!title) {
                    showCreateExamError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö');
                    return;
                }
                
                // Get questions
                const questionItems = document.querySelectorAll('.create-question-item');
                if (questionItems.length === 0) {
                    showCreateExamError('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ç‡πâ‡∏≠');
                    return;
                }
                
                const questions = [];
                let hasError = false;
                
                questionItems.forEach((item, index) => {
                    const questionText = item.querySelector('.create-question-text').value.trim();
                    const choices = Array.from(item.querySelectorAll('.create-choice-text')).map(input => input.value.trim());
                    const explanation = item.querySelector('.create-explanation-text').value.trim();
                    
                    // Validate question
                    if (!questionText) {
                        showCreateExamError(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${index + 1}`);
                        hasError = true;
                        return;
                    }
                    
                    // Validate choices
                    if (choices.some(choice => !choice)) {
                        showCreateExamError(`‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${index + 1}`);
                        hasError = true;
                        return;
                    }
                    
                    // Find correct answer
                    let correctAnswer = 0;
                    const correctButton = item.querySelector('button.bg-green-100');
                    if (correctButton) {
                        const allButtons = Array.from(item.querySelectorAll('button[onclick*="setCreateCorrectAnswer"]'));
                        correctAnswer = allButtons.indexOf(correctButton);
                    }
                    
                    questions.push({
                        id: index + 1,
                        question: questionText,
                        choices: choices,
                        correctAnswer: correctAnswer,
                        explanation: explanation || `‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ ${choices[correctAnswer]}`
                    });
                });
                
                if (hasError) return;
                
                // Create new exam in Firestore
                const examData = {
                    title: title,
                    description: description || `‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ${title}`,
                    timeLimit: timeLimit,
                    questions: questions,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser?.uid || 'unknown'
                };
                
                await db.collection('exams').add(examData);
                
                // Show success message first
                const successModal = document.createElement('div');
                successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                successModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">üéâ</span>
                            </div>
                            <h3 class="text-lg font-bold mb-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                            <p class="text-gray-600 mb-4">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö "${title}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${questions.length} ‡∏Ç‡πâ‡∏≠</p>
                            <button onclick="this.parentElement.parentElement.remove(); loadAdminExamsList()" 
                                    class="bg-green-600 text-white px-6 py-2 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(successModal);
                
            } catch (error) {
                console.error('Error creating new exam:', error);
                showCreateExamError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö');
            }
        }
        
        function showCreateExamError(message) {
            const errorModal = document.createElement('div');
            errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            errorModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl">‚ö†Ô∏è</span>
                        </div>
                        <h3 class="text-lg font-bold mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô</h3>
                        <p class="text-gray-600 mb-4">${message}</p>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                class="bg-red-600 text-white px-6 py-2 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                    </div>
                </div>
            `;
            document.body.appendChild(errorModal);
        }
        
        function deleteExam(examId) {
            const customModal = document.createElement('div');
            customModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            customModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-bold mb-4">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</h3>
                    <p class="text-gray-600 mb-4">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                    <div class="flex space-x-2">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="bg-gray-500 text-white px-4 py-2 rounded">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                        <button onclick="confirmDeleteExam('${examId}'); this.parentElement.parentElement.parentElement.remove()" class="bg-red-600 text-white px-4 py-2 rounded">‡∏•‡∏ö</button>
                    </div>
                </div>
            `;
            document.body.appendChild(customModal);
        }
        
        async function confirmDeleteExam(examId) {
            try {
                // Delete exam from Firestore
                await db.collection('exams').doc(examId).delete();
                
                // Show success message
                const successModal = document.createElement('div');
                successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                successModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">‚úÖ</span>
                            </div>
                            <h3 class="text-lg font-bold mb-2">‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
                            <p class="text-gray-600 mb-4">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß</p>
                            <button onclick="this.parentElement.parentElement.remove(); loadAdminExamsList()" 
                                    class="bg-green-600 text-white px-6 py-2 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(successModal);
                
                // Reload exams list immediately
                loadAdminExamsList();
                
            } catch (error) {
                console.error('Error deleting exam:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö');
            }
        }
        
        function handleCSVFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const csv = event.target.result;
                const lines = csv.split('\n');
                const headers = lines[0].split(',');
                
                if (headers.length < 7 || headers[0].trim() !== 'question') {
                    showError('csv', '‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå CSV ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    return;
                }
                
                const previewBody = document.getElementById('csv-preview-body');
                previewBody.innerHTML = '';
                
                for (let i = 1; i < Math.min(lines.length, 6); i++) {
                    const data = lines[i].split(',');
                    if (data.length >= 7) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${data[0]}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data[1]}, ${data[2]}, ${data[3]}, ${data[4]}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data[5]}</td>
                        `;
                        previewBody.appendChild(row);
                    }
                }
                
                document.getElementById('csv-preview').classList.remove('hidden');
            };
            reader.readAsText(file);
        }
        
        async function importCSVData() {
            const title = document.getElementById('csv-exam-title').value.trim();
            const fileInput = document.getElementById('csv-file');
            const file = fileInput.files[0];
            
            if (!title || !file) {
                const customModal = document.createElement('div');
                customModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                customModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">‚ö†Ô∏è</span>
                            </div>
                            <h3 class="text-lg font-bold mb-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö</h3>
                            <p class="text-gray-600 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV</p>
                            <button onclick="this.parentElement.parentElement.remove()" class="bg-red-600 text-white px-4 py-2 rounded">‡∏ï‡∏Å‡∏•‡∏á</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(customModal);
                return;
            }
            
            // Show loading state
            const importBtn = document.getElementById('import-csv-btn');
            const originalText = importBtn.textContent;
            importBtn.disabled = true;
            importBtn.innerHTML = `
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                    ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...
                </div>
            `;
            
            try {
                // Read CSV file
                const csvText = await readFileAsText(file);
                const lines = csvText.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    throw new Error('‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÅ‡∏ñ‡∏ß');
                }
                
                // Parse header with flexible matching
                const headerLine = lines[0];
                const headers = parseCSVLine(headerLine).map(h => h.trim().toLowerCase());
                
                // Find column indices
                const columnMap = {};
                const requiredColumns = ['question', 'choice1', 'choice2', 'choice3', 'choice4', 'answer', 'explanation'];
                
                requiredColumns.forEach(col => {
                    const index = headers.findIndex(h => 
                        h === col || 
                        h.includes(col) || 
                        col.includes(h.replace(/[^a-z0-9]/g, ''))
                    );
                    if (index !== -1) {
                        columnMap[col] = index;
                    }
                });
                
                // Validate required columns
                const missingColumns = requiredColumns.filter(col => columnMap[col] === undefined);
                if (missingColumns.length > 0) {
                    throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô: ${missingColumns.join(', ')}\n‡∏û‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå: ${headers.join(', ')}`);
                }
                
                // Parse questions with duplicate detection
                const questions = [];
                const errors = [];
                const seenQuestions = new Set(); // Track duplicate questions
                let processedCount = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const lineNumber = i + 1;
                    processedCount++;
                    
                    try {
                        const data = parseCSVLine(lines[i]);
                        
                        if (data.length < Math.max(...Object.values(columnMap)) + 1) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${lineNumber}: ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå`);
                            continue;
                        }
                        
                        // Extract data using column mapping
                        const questionText = data[columnMap.question]?.trim() || '';
                        const choice1 = data[columnMap.choice1]?.trim() || '';
                        const choice2 = data[columnMap.choice2]?.trim() || '';
                        const choice3 = data[columnMap.choice3]?.trim() || '';
                        const choice4 = data[columnMap.choice4]?.trim() || '';
                        const answer = data[columnMap.answer]?.trim() || '';
                        const explanation = data[columnMap.explanation]?.trim() || '';
                        
                        // Validate required fields
                        if (!questionText) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${lineNumber}: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°`);
                            continue;
                        }
                        
                        // Check for duplicate questions
                        const questionKey = questionText.toLowerCase().replace(/\s+/g, ' ');
                        if (seenQuestions.has(questionKey)) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${lineNumber}: ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ "${questionText.substring(0, 50)}..."`);
                            continue;
                        }
                        seenQuestions.add(questionKey);
                        
                        const choices = [choice1, choice2, choice3, choice4];
                        if (choices.some(c => !c)) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${lineNumber}: ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö (‡∏û‡∏ö: ${choices.filter(c => c).length}/4)`);
                            continue;
                        }
                        
                        // Check for duplicate choices
                        const uniqueChoices = new Set(choices.map(c => c.toLowerCase()));
                        if (uniqueChoices.size !== choices.length) {
                            errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${lineNumber}: ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô`);
                            continue;
                        }
                        
                        // Parse correct answer with better matching
                        let correctAnswer = 0;
                        const answerText = answer.toLowerCase().trim();
                        
                        if (answerText === 'a' || answerText === '1') correctAnswer = 0;
                        else if (answerText === 'b' || answerText === '2') correctAnswer = 1;
                        else if (answerText === 'c' || answerText === '3') correctAnswer = 2;
                        else if (answerText === 'd' || answerText === '4') correctAnswer = 3;
                        else {
                            // Try exact match first
                            let matchIndex = choices.findIndex(choice => 
                                choice.toLowerCase().trim() === answerText
                            );
                            
                            // If no exact match, try partial match
                            if (matchIndex === -1) {
                                matchIndex = choices.findIndex(choice => 
                                    choice.toLowerCase().includes(answerText) || 
                                    answerText.includes(choice.toLowerCase())
                                );
                            }
                            
                            if (matchIndex !== -1) {
                                correctAnswer = matchIndex;
                            } else {
                                errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${lineNumber}: ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö "${answer}" ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏î‡πÜ\n‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏°‡∏µ: ${choices.join(', ')}`);
                                continue;
                            }
                        }
                        
                        // Create question object
                        const questionObj = {
                            id: questions.length + 1,
                            question: questionText,
                            choices: choices,
                            correctAnswer: correctAnswer,
                            explanation: explanation || `‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏∑‡∏≠ ${choices[correctAnswer]}`,
                            sourceRow: lineNumber
                        };
                        
                        questions.push(questionObj);
                        
                    } catch (error) {
                        errors.push(`‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà ${lineNumber}: ${error.message}`);
                    }
                }
                
                // Show detailed results
                const successCount = questions.length;
                const errorCount = errors.length;
                const totalRows = processedCount;
                
                console.log(`üìä CSV Import Results:
                    - ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalRows} ‡πÅ‡∏ñ‡∏ß
                    - ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏Ç‡πâ‡∏≠
                    - ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errorCount} ‡∏Ç‡πâ‡∏≠
                    - ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${Math.round((successCount/totalRows)*100)}%`);
                
                // Show results modal
                if (errors.length > 0 || successCount < totalRows) {
                    const resultModal = document.createElement('div');
                    resultModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto';
                    resultModal.innerHTML = `
                        <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 my-8 max-h-screen overflow-y-auto">
                            <div class="text-center mb-6">
                                <div class="w-16 h-16 ${successCount > 0 ? 'bg-blue-100' : 'bg-red-100'} rounded-full flex items-center justify-center mx-auto mb-4">
                                    <span class="text-2xl">${successCount > 0 ? 'üìä' : '‚ùå'}</span>
                                </div>
                                <h3 class="text-xl font-bold mb-2">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå CSV</h3>
                                <div class="grid grid-cols-3 gap-4 mb-4">
                                    <div class="bg-gray-50 rounded-lg p-3">
                                        <div class="text-2xl font-bold text-gray-700">${totalRows}</div>
                                        <div class="text-sm text-gray-600">‡πÅ‡∏ñ‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                                    </div>
                                    <div class="bg-green-50 rounded-lg p-3">
                                        <div class="text-2xl font-bold text-green-700">${successCount}</div>
                                        <div class="text-sm text-green-600">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</div>
                                    </div>
                                    <div class="bg-red-50 rounded-lg p-3">
                                        <div class="text-2xl font-bold text-red-700">${errorCount}</div>
                                        <div class="text-sm text-red-600">‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</div>
                                    </div>
                                </div>
                                <div class="text-sm text-gray-600">
                                    ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: <span class="font-bold">${Math.round((successCount/totalRows)*100)}%</span>
                                </div>
                            </div>
                            
                            ${errors.length > 0 ? `
                                <div class="mb-6">
                                    <h4 class="font-bold text-red-800 mb-3 flex items-center">
                                        <span class="mr-2">‚ö†Ô∏è</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î (${errorCount} ‡∏Ç‡πâ‡∏≠)
                                    </h4>
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-4 max-h-60 overflow-y-auto">
                                        <ul class="text-sm text-red-700 space-y-1">
                                            ${errors.map(error => `<li>‚Ä¢ ${error}</li>`).join('')}
                                        </ul>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${successCount > 0 ? `
                                <div class="mb-6">
                                    <h4 class="font-bold text-green-800 mb-3 flex items-center">
                                        <span class="mr-2">‚úÖ</span> ‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${successCount} ‡∏Ç‡πâ‡∏≠)
                                    </h4>
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4 max-h-40 overflow-y-auto">
                                        <ul class="text-sm text-green-700 space-y-1">
                                            ${questions.slice(0, 10).map((q, idx) => 
                                                `<li>‚Ä¢ ‡∏Ç‡πâ‡∏≠ ${idx + 1}: ${q.question.substring(0, 80)}${q.question.length > 80 ? '...' : ''}</li>`
                                            ).join('')}
                                            ${questions.length > 10 ? `<li class="font-medium">... ‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡∏Å ${questions.length - 10} ‡∏Ç‡πâ‡∏≠</li>` : ''}
                                        </ul>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="flex space-x-3">
                                <button onclick="this.closest('.fixed').remove()" 
                                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                                </button>
                                ${successCount > 0 ? `
                                    <button onclick="proceedWithPartialImport('${title}', ${JSON.stringify(questions).replace(/"/g, '&quot;')}); this.closest('.fixed').remove()" 
                                            class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                                        ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ${successCount} ‡∏Ç‡πâ‡∏≠
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    document.body.appendChild(resultModal);
                    
                    // Reset button
                    importBtn.disabled = false;
                    importBtn.textContent = originalText;
                    return;
                }
                
                if (questions.length === 0) {
                    throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CSV');
                }
                
                // Create exam in Firebase
                await createExamFromCSV(title, questions);
                
            } catch (error) {
                console.error('CSV import error:', error);
                
                const errorModal = document.createElement('div');
                errorModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                errorModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">‚ùå</span>
                            </div>
                            <h3 class="text-lg font-bold mb-2">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</h3>
                            <p class="text-gray-600 mb-4 text-sm">${error.message}</p>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    class="bg-red-600 text-white px-4 py-2 rounded">‡∏ï‡∏Å‡∏•‡∏á</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(errorModal);
            } finally {
                // Reset button
                importBtn.disabled = false;
                importBtn.textContent = originalText;
            }
        }
        
        // Helper function to read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ'));
                reader.readAsText(file, 'UTF-8');
            });
        }
        
        // Helper function to parse CSV line (handles quotes and commas)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result.map(item => item.replace(/^"|"$/g, '').trim());
        }
        
        // Function to create exam from CSV data
        async function createExamFromCSV(title, questions) {
            try {
                const examData = {
                    title: title,
                    description: `‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö ${title} (‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏≤‡∏Å CSV)`,
                    timeLimit: 60, // Default 60 minutes
                    questions: questions,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser?.uid || 'unknown',
                    importedFromCSV: true
                };
                
                await db.collection('exams').add(examData);
                
                // Show success message
                const successModal = document.createElement('div');
                successModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                successModal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">üéâ</span>
                            </div>
                            <h3 class="text-lg font-bold mb-2">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                            <p class="text-gray-600 mb-4">
                                ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö "${title}" ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br>
                                ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${questions.length} ‡∏Ç‡πâ‡∏≠
                            </p>
                            <button onclick="this.parentElement.parentElement.remove(); loadAdminExamsList()" 
                                    class="bg-green-600 text-white px-6 py-2 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(successModal);
                
                // Clear form
                document.getElementById('csv-exam-title').value = '';
                document.getElementById('csv-file').value = '';
                document.getElementById('csv-preview').classList.add('hidden');
                
                // Refresh admin exams list immediately
                loadAdminExamsList();
                
            } catch (error) {
                console.error('Error creating exam from CSV:', error);
                throw new Error('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏ô Firebase ‡πÑ‡∏î‡πâ');
            }
        }
        
        // Function to proceed with partial import
        async function proceedWithPartialImport(title, questions) {
            try {
                await createExamFromCSV(title, questions);
            } catch (error) {
                console.error('Error in partial import:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            }
        }

        // History management functions
        function showFullHistory() {
            showPage('history');
        }
        
        async function loadFullHistory() {
            if (!currentUser) return;
            
            try {
                // Get all user results
                const userResults = examResults
                    .filter(result => result.user_id === currentUser.email)
                    .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));
                
                // Update statistics
                updateHistoryStatistics(userResults);
                
                // Load exam filter options
                await loadExamFilterOptions();
                
                // Display history list
                displayHistoryList(userResults);
                
                // Setup filter event listeners
                setupHistoryFilters();
                
            } catch (error) {
                console.error('Error loading full history:', error);
            }
        }
        
        function updateHistoryStatistics(userResults) {
            const totalExams = userResults.length;
            const averageScore = totalExams > 0 ? Math.round(userResults.reduce((sum, result) => sum + result.score, 0) / totalExams) : 0;
            const highestScore = totalExams > 0 ? Math.max(...userResults.map(result => result.score)) : 0;
            const passedExams = userResults.filter(result => result.score >= 80).length;
            const passRate = totalExams > 0 ? Math.round((passedExams / totalExams) * 100) : 0;
            
            document.getElementById('history-total-exams').textContent = totalExams;
            document.getElementById('history-average-score').textContent = `${averageScore}%`;
            document.getElementById('history-highest-score').textContent = `${highestScore}%`;
            document.getElementById('history-pass-rate').textContent = `${passRate}%`;
        }
        
        async function loadExamFilterOptions() {
            try {
                const examFilter = document.getElementById('exam-filter');
                examFilter.innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</option>';
                
                // Get unique exam IDs from user results
                const userResults = examResults.filter(result => result.user_id === currentUser.email);
                const uniqueExamIds = [...new Set(userResults.map(result => result.exam_id))];
                
                // Get exam titles from Firestore
                const examsSnapshot = await db.collection('exams').get();
                const examTitles = {};
                examsSnapshot.forEach(doc => {
                    examTitles[doc.id] = doc.data().title;
                });
                
                // Add options for exams that user has taken
                uniqueExamIds.forEach(examId => {
                    const examTitle = examTitles[examId] || '‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
                    const option = document.createElement('option');
                    option.value = examId;
                    option.textContent = examTitle;
                    examFilter.appendChild(option);
                });
                
            } catch (error) {
                console.error('Error loading exam filter options:', error);
            }
        }
        
        function displayHistoryList(results) {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (results.length === 0) {
                historyList.innerHTML = `
                    <li class="px-4 py-8 text-center text-gray-500">
                        <div class="text-4xl mb-2">üìä</div>
                        <p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö</p>
                    </li>
                `;
                return;
            }
            
            results.forEach(async (result, index) => {
                // Get exam title
                let examTitle = '‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
                try {
                    const examDoc = await db.collection('exams').doc(result.exam_id).get();
                    if (examDoc.exists) {
                        examTitle = examDoc.data().title;
                    }
                } catch (error) {
                    console.error('Error getting exam title:', error);
                }
                
                const completedDate = new Date(result.completed_at).toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                const completedTime = new Date(result.completed_at).toLocaleTimeString('th-TH', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const correctAnswers = Math.round((result.score / 100) * result.total_questions);
                const wrongAnswers = result.total_questions - correctAnswers;
                
                const historyItem = document.createElement('li');
                historyItem.className = 'history-item';
                historyItem.setAttribute('data-exam-id', result.exam_id);
                historyItem.setAttribute('data-score', result.score);
                
                historyItem.innerHTML = `
                    <div class="px-6 py-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <div class="flex-shrink-0">
                                    <div class="w-16 h-16 rounded-lg ${result.score >= 80 ? 'bg-green-500' : result.score >= 60 ? 'bg-yellow-500' : 'bg-red-500'} flex items-center justify-center shadow-md">
                                        <div class="text-center">
                                            <div class="text-white font-bold text-lg">${result.score}%</div>
                                            <div class="text-white text-xs">${result.score >= 80 ? '‡∏ú‡πà‡∏≤‡∏ô' : result.score >= 60 ? '‡∏û‡∏≠‡πÉ‡∏ä‡πâ' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center space-x-2 mb-1">
                                        <h3 class="text-lg font-medium text-gray-900">${examTitle}</h3>
                                        <span class="px-2 py-1 text-xs font-medium rounded-full ${result.score >= 80 ? 'bg-green-100 text-green-800' : result.score >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                            #${index + 1}
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-600 mb-2">
                                        üìÖ ${completedDate} ‡πÄ‡∏ß‡∏•‡∏≤ ${completedTime}
                                    </div>
                                    <div class="flex items-center space-x-4 text-sm text-gray-500">
                                        <span>‚è±Ô∏è ${Math.floor(result.time_taken / 60)}:${(result.time_taken % 60).toString().padStart(2, '0')}</span>
                                        <span>‚úÖ ${correctAnswers} ‡∏Ç‡πâ‡∏≠</span>
                                        <span>‚ùå ${wrongAnswers} ‡∏Ç‡πâ‡∏≠</span>
                                        <span>üìä ${result.total_questions} ‡∏Ç‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col space-y-2">
                                <button onclick="showDetailedResult('${result.id}')" 
                                        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                    üìã ‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢
                                </button>
                                <button onclick="retakeExam('${result.exam_id}')" 
                                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm transition-colors">
                                    üîÑ ‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                historyList.appendChild(historyItem);
            });
        }
        
        function setupHistoryFilters() {
            const examFilter = document.getElementById('exam-filter');
            const scoreFilter = document.getElementById('score-filter');
            
            examFilter.addEventListener('change', applyHistoryFilters);
            scoreFilter.addEventListener('change', applyHistoryFilters);
        }
        
        function applyHistoryFilters() {
            const examFilter = document.getElementById('exam-filter').value;
            const scoreFilter = document.getElementById('score-filter').value;
            const historyItems = document.querySelectorAll('.history-item');
            
            historyItems.forEach(item => {
                let showItem = true;
                
                // Filter by exam
                if (examFilter && item.getAttribute('data-exam-id') !== examFilter) {
                    showItem = false;
                }
                
                // Filter by score range
                if (scoreFilter) {
                    const score = parseInt(item.getAttribute('data-score'));
                    const [minScore, maxScore] = scoreFilter.split('-').map(Number);
                    if (score < minScore || score > maxScore) {
                        showItem = false;
                    }
                }
                
                item.style.display = showItem ? 'block' : 'none';
            });
        }
        
        function clearHistoryFilters() {
            document.getElementById('exam-filter').value = '';
            document.getElementById('score-filter').value = '';
            applyHistoryFilters();
        }
        
        function showDetailedResult(resultId) {
            const result = examResults.find(r => r.id === resultId);
            if (!result) return;
            
            // Create detailed result modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-4xl w-full mx-4 my-8 max-h-screen overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-blue-600">${result.score}%</div>
                            <div class="text-sm text-gray-600">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-green-600">${Math.round((result.score / 100) * result.total_questions)}</div>
                            <div class="text-sm text-gray-600">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 text-center">
                            <div class="text-3xl font-bold text-red-600">${result.total_questions - Math.round((result.score / 100) * result.total_questions)}</div>
                            <div class="text-sm text-gray-600">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                            <div>
                                <span class="font-medium text-gray-700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥:</span>
                                <div class="text-gray-900">${new Date(result.completed_at).toLocaleDateString('th-TH')}</div>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≥:</span>
                                <div class="text-gray-900">${new Date(result.completed_at).toLocaleTimeString('th-TH')}</div>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</span>
                                <div class="text-gray-900">${Math.floor(result.time_taken / 60)}:${(result.time_taken % 60).toString().padStart(2, '0')}</div>
                            </div>
                            <div>
                                <span class="font-medium text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                                <div class="text-gray-900 ${result.score >= 80 ? 'text-green-600' : result.score >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                    ${result.score >= 80 ? 'üéâ ‡∏ú‡πà‡∏≤‡∏ô' : result.score >= 60 ? '‚ö†Ô∏è ‡∏û‡∏≠‡πÉ‡∏ä‡πâ' : '‚ùå ‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <p class="text-gray-600 mb-4">‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?</p>
                        <div class="space-x-3">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors">
                                ‡∏õ‡∏¥‡∏î
                            </button>
                            <button onclick="loadDetailedAnswerReview('${result.id}'); this.closest('.fixed').remove()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-colors">
                                üìã ‡∏î‡∏π‡πÄ‡∏â‡∏•‡∏¢‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function loadDetailedAnswerReview(resultId) {
            const result = examResults.find(r => r.id === resultId);
            if (!result) return;
            
            try {
                // Get exam data
                const examDoc = await db.collection('exams').doc(result.exam_id).get();
                if (!examDoc.exists) return;
                
                const examData = examDoc.data();
                const userAnswers = JSON.parse(result.answers);
                
                // Create detailed answer review modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 overflow-y-auto';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-5xl w-full mx-4 my-8 max-h-screen overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-2xl font-bold text-gray-900">‡πÄ‡∏â‡∏•‡∏¢‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö: ${examData.title}</h3>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-6">
                            ${examData.questions.map((question, index) => {
                                const isCorrect = userAnswers[index] === question.correctAnswer;
                                const userChoice = userAnswers[index] !== null ? question.choices[userAnswers[index]] : '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏≠‡∏ö';
                                const correctChoice = question.choices[question.correctAnswer];
                                
                                return `
                                    <div class="border rounded-lg p-6 ${isCorrect ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}">
                                        <div class="flex items-start justify-between mb-4">
                                            <h4 class="font-medium text-gray-900 text-lg">‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${index + 1}</h4>
                                            <span class="px-3 py-1 rounded-full text-sm font-medium ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                                ${isCorrect ? '‚úì ‡∏ñ‡∏π‡∏Å' : '‚úó ‡∏ú‡∏¥‡∏î'}
                                            </span>
                                        </div>
                                        
                                        <p class="text-gray-700 mb-4 text-lg">${question.question}</p>
                                        
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                                            ${question.choices.map((choice, choiceIndex) => `
                                                <div class="p-3 rounded-lg border ${
                                                    choiceIndex === question.correctAnswer ? 'border-green-300 bg-green-100' :
                                                    choiceIndex === userAnswers[index] && !isCorrect ? 'border-red-300 bg-red-100' :
                                                    'border-gray-200 bg-gray-50'
                                                }">
                                                    <div class="flex items-center">
                                                        <span class="font-medium mr-2">${String.fromCharCode(65 + choiceIndex)}.</span>
                                                        <span>${choice}</span>
                                                        ${choiceIndex === question.correctAnswer ? '<span class="ml-auto text-green-600 font-bold">‚úì</span>' : ''}
                                                        ${choiceIndex === userAnswers[index] && !isCorrect ? '<span class="ml-auto text-red-600 font-bold">‚úó</span>' : ''}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                        
                                        <div class="bg-white rounded-lg p-4 border border-gray-200">
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-3">
                                                <div>
                                                    <span class="font-medium text-gray-700">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</span>
                                                    <span class="ml-2 ${isCorrect ? 'text-green-600' : 'text-red-600'}">${userChoice}</span>
                                                </div>
                                                <div>
                                                    <span class="font-medium text-gray-700">‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å:</span>
                                                    <span class="ml-2 text-green-600">${correctChoice}</span>
                                                </div>
                                            </div>
                                            <div class="border-t pt-3">
                                                <span class="font-medium text-gray-700">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</span>
                                                <p class="text-gray-600 mt-1">${question.explanation}</p>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div class="mt-8 text-center">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-lg transition-colors">
                                ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (error) {
                console.error('Error loading detailed answer review:', error);
            }
        }
        
        function retakeExam(examId) {
            startExam(examId);
        }
        
        function exportHistoryToCSV() {
            const userResults = examResults
                .filter(result => result.user_id === currentUser.email)
                .sort((a, b) => new Date(b.completed_at) - new Date(a.completed_at));
            
            if (userResults.length === 0) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <div class="text-center">
                            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span class="text-2xl">üìä</span>
                            </div>
                            <h3 class="text-lg font-bold mb-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
                            <p class="text-gray-600 mb-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å</p>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    class="bg-yellow-600 text-white px-6 py-2 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                return;
            }
            
            // Create CSV content
            const headers = ['‡∏•‡∏≥‡∏î‡∏±‡∏ö', '‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (%)', '‡∏Ç‡πâ‡∏≠‡∏ñ‡∏π‡∏Å', '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î', '‡∏Ç‡πâ‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ (‡∏ô‡∏≤‡∏ó‡∏µ)', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏≥', '‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ó‡∏≥', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'];
            let csvContent = headers.join(',') + '\n';
            
            userResults.forEach((result, index) => {
                const correctAnswers = Math.round((result.score / 100) * result.total_questions);
                const wrongAnswers = result.total_questions - correctAnswers;
                const timeInMinutes = Math.round(result.time_taken / 60 * 100) / 100;
                const date = new Date(result.completed_at).toLocaleDateString('th-TH');
                const time = new Date(result.completed_at).toLocaleTimeString('th-TH');
                const status = result.score >= 80 ? '‡∏ú‡πà‡∏≤‡∏ô' : result.score >= 60 ? '‡∏û‡∏≠‡πÉ‡∏ä‡πâ' : '‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô';
                
                const row = [
                    index + 1,
                    `"‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö ${result.exam_id}"`,
                    result.score,
                    correctAnswers,
                    wrongAnswers,
                    result.total_questions,
                    timeInMinutes,
                    `"${date}"`,
                    `"${time}"`,
                    `"${status}"`
                ];
                
                csvContent += row.join(',') + '\n';
            });
            
            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö_${currentUser.name}_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Show success message
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <div class="text-center">
                        <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl">üìä</span>
                        </div>
                        <h3 class="text-lg font-bold mb-2">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                        <p class="text-gray-600 mb-4">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß<br>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${userResults.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                        <button onclick="this.parentElement.parentElement.remove()" 
                                class="bg-green-600 text-white px-6 py-2 rounded-lg">‡∏ï‡∏Å‡∏•‡∏á</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üìÑ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
            // Firebase initialization is handled by initializeFirebase() function above
        });

        // Fallback initialization
        window.addEventListener('load', () => {
            console.log('üåê ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß');
            
            // Check if still loading
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen && !loadingScreen.classList.contains('hidden')) {
                console.log('üîÑ ‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firebase...');
                
                // If Firebase hasn't initialized after 3 seconds, show error
                setTimeout(() => {
                    if (!isFirebaseMode && loadingScreen && !loadingScreen.classList.contains('hidden')) {
                        console.log('‚è∞ Firebase ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î');
                        showFirebaseError(new Error('Firebase ‡πÑ‡∏°‡πà‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î'));
                    }
                }, 3000);
            }
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'99f58b8ca42645cc',t:'MTc2MzI4MDk3Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
